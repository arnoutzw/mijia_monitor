<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#09090b">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>FSCMS — Fillament Storage Climate Monitoring System</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="icons/icon-192.svg">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: {
        sans: ['Inter', 'sans-serif'],
        mono: ['JetBrains Mono', 'monospace']
      }
    }
  }
}
</script>
<style>
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: #18181b; }
::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #52525b; }
.chart-wrap { position: relative; height: 250px; }
</style>
</head>
<body class="bg-zinc-950 text-zinc-300 font-sans text-sm min-h-screen flex flex-col">

  <!-- Alert Banner -->
  <div id="alertBanner" class="hidden border-b px-5 py-3 text-center font-mono font-bold text-sm"></div>

  <!-- Header -->
  <header class="sticky top-0 z-40 bg-zinc-900/80 backdrop-blur-sm border-b border-zinc-800 px-4 md:px-6 py-3 flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <div class="flex gap-1.5">
        <div class="w-3 h-3 rounded-full bg-red-500"></div>
        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
        <div class="w-3 h-3 rounded-full bg-green-500"></div>
      </div>
      <h1 class="font-mono font-bold text-lg text-amber-500">FSCMS<span class="text-zinc-500 font-normal text-xs ml-2">v2.0</span></h1>
    </div>
    <div class="flex gap-2 items-center">
      <div id="statusDot" class="w-2.5 h-2.5 rounded-full bg-red-500 ring-2 ring-red-500/30" title="No devices connected"></div>
      <div id="bleModeToggle" class="flex items-center gap-1.5 bg-zinc-800 border border-zinc-700 rounded-lg px-2 py-1.5" title="BLE receive mode">
        <span id="bleModeLabel" class="text-[10px] font-mono text-zinc-500 hidden sm:inline">POLL</span>
        <button onclick="toggleBleMode()" class="relative w-9 h-5 rounded-full transition-colors bg-zinc-600" id="bleModeSwitch">
          <span id="bleModeDot" class="absolute top-0.5 left-0.5 w-4 h-4 rounded-full bg-zinc-300 transition-all duration-200"></span>
        </button>
        <span id="bleModeLabel2" class="text-[10px] font-mono text-zinc-500 hidden sm:inline">ADV</span>
      </div>
      <button id="btnAlertHistory" onclick="openAlertHistory()" class="relative bg-zinc-700 hover:bg-zinc-600 text-zinc-400 text-xs font-mono p-2 rounded-lg transition-colors" title="Alert History">
        <i data-lucide="bell" class="w-4 h-4"></i>
        <span id="alertBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold rounded-full w-4 h-4 flex items-center justify-center"></span>
      </button>
      <button id="btnReconnectAll" onclick="batchReconnect()" class="bg-zinc-700 hover:bg-zinc-600 text-zinc-400 text-xs font-mono px-3 py-2 rounded-lg transition-colors flex items-center gap-1.5" title="Reconnect all saved devices sequentially">
        <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i> Reconnect All
      </button>
      <button onclick="openDebugPanel()" class="bg-zinc-700 hover:bg-zinc-600 text-zinc-400 text-xs font-mono px-3 py-2 rounded-lg transition-colors flex items-center gap-1.5" title="BLE Debug Log">
        <i data-lucide="terminal" class="w-3.5 h-3.5"></i> Debug
      </button>
      <button onclick="openAddSensorModal()" class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2 rounded-lg transition-colors text-sm flex items-center gap-2">
        <i data-lucide="plus" class="w-4 h-4"></i> Add Sensor
      </button>
    </div>
  </header>

  <main class="flex-1 max-w-7xl w-full mx-auto p-4 md:p-6">

    <!-- Tabs -->
    <div class="flex gap-1 mb-6 bg-zinc-900 rounded-lg p-1 border border-zinc-800">
      <button class="tab-btn flex-1 text-center py-2.5 rounded-lg font-mono text-xs font-bold transition-colors bg-amber-500 text-zinc-900" data-tab="dashboard">
        <i data-lucide="layout-dashboard" class="w-3.5 h-3.5 inline-block mr-1 -mt-0.5"></i>Dashboard
      </button>
      <button class="tab-btn flex-1 text-center py-2.5 rounded-lg font-mono text-xs font-bold transition-colors text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800" data-tab="charts">
        <i data-lucide="bar-chart-3" class="w-3.5 h-3.5 inline-block mr-1 -mt-0.5"></i>Charts
      </button>
      <button class="tab-btn flex-1 text-center py-2.5 rounded-lg font-mono text-xs font-bold transition-colors text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800" data-tab="flasher">
        <i data-lucide="zap" class="w-3.5 h-3.5 inline-block mr-1 -mt-0.5"></i>Flasher
      </button>
      <button class="tab-btn flex-1 text-center py-2.5 rounded-lg font-mono text-xs font-bold transition-colors text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800" data-tab="settings">
        <i data-lucide="settings" class="w-3.5 h-3.5 inline-block mr-1 -mt-0.5"></i>Settings
      </button>
      <button class="tab-btn flex-1 text-center py-2.5 rounded-lg font-mono text-xs font-bold transition-colors text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800" data-tab="about">
        <i data-lucide="info" class="w-3.5 h-3.5 inline-block mr-1 -mt-0.5"></i>About
      </button>
    </div>

    <!-- Dashboard Tab -->
    <div class="tab-content" id="tab-dashboard">
      <div class="flex items-center justify-end gap-2 mb-4">
        <i data-lucide="battery-charging" class="w-3.5 h-3.5 text-zinc-500"></i>
        <select id="batteryProfileSelect" onchange="selectBatteryProfile(this.value)" class="bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-1.5 font-mono text-xs text-zinc-300 focus:border-amber-500 focus:outline-none cursor-pointer">
        </select>
        <span id="batteryProfileStatus" class="text-[10px] font-mono text-zinc-500 hidden"></span>
      </div>
      <div id="sensorGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6"></div>
      <div id="connectPanel" class="text-center py-16 px-6">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-zinc-800 border border-zinc-700 mb-4">
          <i data-lucide="radio" class="w-8 h-8 text-zinc-500"></i>
        </div>
        <h2 class="font-mono font-bold text-xl text-zinc-100 mb-2">No Sensors Connected</h2>
        <p class="text-zinc-500 mb-6 max-w-md mx-auto">Connect a Mijia LYWSD03MMC sensor via Bluetooth to start monitoring your filament storage conditions.</p>
        <button onclick="openAddSensorModal()" class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-6 py-2.5 rounded-lg transition-colors inline-flex items-center gap-2">
          <i data-lucide="plus" class="w-4 h-4"></i> Add Sensor
        </button>
        <p class="text-xs text-zinc-600 font-mono mt-4">Pair ATC sensors or manually pick any BLE device.<br>Previously paired sensors reconnect automatically on page load.</p>
      </div>
    </div>

    <!-- Charts Tab -->
    <div class="tab-content hidden" id="tab-charts">
      <div id="chartsContainer"></div>
      <div id="noChartsMsg" class="text-center py-16 text-zinc-500 font-mono">
        <i data-lucide="bar-chart-3" class="w-10 h-10 mx-auto mb-3 text-zinc-600"></i>
        <p>Connect sensors to see historical charts.</p>
      </div>
    </div>

    <!-- Flasher Tab -->
    <div class="tab-content hidden" id="tab-flasher">

      <!-- Mode Toggle -->
      <div class="flex justify-center mb-6">
        <div class="inline-flex bg-zinc-900 border border-zinc-700 rounded-lg p-1 gap-1">
          <button id="flasherModeSimple" onclick="setFlasherMode('simple')" class="px-5 py-2 rounded-lg font-mono text-xs font-bold transition-colors bg-amber-500 text-zinc-900">
            <i data-lucide="zap" class="w-3.5 h-3.5 inline-block mr-1 -mt-0.5"></i>Simple
          </button>
          <button id="flasherModeAdvanced" onclick="setFlasherMode('advanced')" class="px-5 py-2 rounded-lg font-mono text-xs font-bold transition-colors text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800">
            <i data-lucide="settings" class="w-3.5 h-3.5 inline-block mr-1 -mt-0.5"></i>Advanced
          </button>
        </div>
      </div>

      <!-- ═══ SIMPLE MODE ═══ -->
      <div id="flasherSimple" class="max-w-2xl mx-auto">
        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <div class="flex items-center gap-3 mb-5">
            <div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center">
              <i data-lucide="zap" class="w-5 h-5 text-amber-500"></i>
            </div>
            <div>
              <h2 class="font-mono font-bold text-zinc-100 text-lg">Firmware Update</h2>
              <p class="text-xs text-zinc-500 font-mono">Telink OTA over BLE</p>
            </div>
          </div>

          <div class="mb-4">
            <label class="text-xs text-zinc-500 font-mono block mb-1.5">Target Device</label>
            <select id="otaDeviceSelect" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-4 py-2.5 font-mono text-sm text-zinc-100 focus:border-amber-500 focus:outline-none">
              <option value="">— connect a sensor first —</option>
            </select>
          </div>

          <div id="fileDrop" class="border-2 border-dashed border-zinc-700 rounded-lg p-8 text-center mb-4 cursor-pointer hover:border-amber-500/50 transition-colors">
            <input type="file" id="fwFile" accept=".bin" class="hidden">
            <i data-lucide="upload" class="w-8 h-8 text-zinc-500 mx-auto mb-3"></i>
            <p class="text-zinc-400 text-sm">Drop firmware <span class="font-mono text-amber-500">.bin</span> file here or click to browse</p>
          </div>

          <div id="fwInfo" class="hidden bg-zinc-800 rounded-lg p-4 mb-4 font-mono text-xs space-y-1.5"></div>

          <div id="otaProgress" class="hidden w-full h-3 bg-zinc-800 rounded-full overflow-hidden mb-4">
            <div id="otaProgressFill" class="h-full bg-gradient-to-r from-amber-500 to-orange-500 rounded-full transition-all duration-100" style="width:0%"></div>
          </div>

          <div id="otaStatus" class="text-center text-sm text-zinc-500 font-mono mb-4"></div>

          <button id="btnFlash" disabled onclick="startOTA()" class="w-full bg-amber-500 hover:bg-amber-400 disabled:opacity-30 disabled:cursor-not-allowed text-zinc-900 font-mono font-bold px-4 py-2.5 rounded-lg transition-colors flex items-center justify-center gap-2">
            <i data-lucide="zap" class="w-4 h-4"></i> Flash Firmware
          </button>
        </div>
      </div>

      <!-- ═══ ADVANCED MODE ═══ -->
      <div id="flasherAdvanced" class="hidden max-w-4xl mx-auto space-y-4">

        <!-- Flasher Connection -->
        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-mono font-bold text-amber-500 text-sm flex items-center gap-2">
              <i data-lucide="bluetooth" class="w-4 h-4"></i> Device Connection
            </h3>
            <span id="flConnStatus" class="text-xs font-mono px-2 py-0.5 rounded bg-zinc-800 text-zinc-500">Disconnected</span>
          </div>
          <div class="flex gap-3 mb-4">
            <div class="flex-1">
              <label class="text-xs text-zinc-500 font-mono block mb-1.5">Name Prefix Filter</label>
              <input type="text" id="flNamePrefix" value="ATC_" placeholder="ATC_" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-sm text-zinc-100 focus:border-amber-500 focus:outline-none">
            </div>
            <div class="flex items-end gap-2">
              <button id="btnFlConnect" onclick="flasherConnect()" class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-2 rounded-lg transition-colors text-sm flex items-center gap-2">
                <i data-lucide="bluetooth" class="w-4 h-4"></i> Connect
              </button>
              <button id="btnFlDisconnect" onclick="flasherDisconnect()" class="hidden bg-zinc-700 hover:bg-zinc-600 text-zinc-300 font-mono font-bold px-4 py-2 rounded-lg transition-colors text-sm flex items-center gap-2">
                <i data-lucide="bluetooth-off" class="w-4 h-4"></i> Disconnect
              </button>
            </div>
          </div>

          <!-- Device Info -->
          <div id="flDeviceInfo" class="hidden bg-zinc-800/50 rounded-lg p-4 font-mono text-xs space-y-1.5 border border-zinc-700/50">
            <div class="text-amber-500 font-bold mb-2">DEVICE INFO</div>
            <div id="flDevInfoContent"></div>
          </div>
        </div>

        <!-- Custom Config -->
        <div id="flConfigSection" class="hidden bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-mono font-bold text-amber-500 text-sm flex items-center gap-2">
              <i data-lucide="sliders-horizontal" class="w-4 h-4"></i> Sensor Configuration
            </h3>
            <div class="flex gap-2">
              <button onclick="flasherReadConfig()" class="text-xs text-zinc-500 hover:text-zinc-300 font-mono px-2 py-1 rounded bg-zinc-800 hover:bg-zinc-700 transition-colors">Read Config</button>
              <button onclick="flasherWriteConfig()" class="text-xs text-amber-500 hover:text-amber-400 font-mono px-2 py-1 rounded bg-amber-500/10 hover:bg-amber-500/20 transition-colors border border-amber-500/20">Write Config</button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Advertising -->
            <div class="space-y-3">
              <div class="text-xs text-zinc-500 font-mono font-bold">ADVERTISING</div>
              <div>
                <label class="text-xs text-zinc-500 font-mono block mb-1">Advertising Type</label>
                <select id="flAdvType" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
                  <option value="0">ATC1441</option>
                  <option value="1">Custom (PVVX)</option>
                  <option value="2">Mi-Like (Xiaomi)</option>
                  <option value="3">BTHome v1</option>
                  <option value="4">BTHome v2</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-zinc-500 font-mono block mb-1">Advertising Interval (ms)</label>
                <input type="number" id="flAdvInterval" value="2500" min="250" max="10000" step="50" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
              </div>
              <div>
                <label class="text-xs text-zinc-500 font-mono block mb-1">Measure Interval (s)</label>
                <input type="number" id="flMeasInterval" value="4" min="2" max="255" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
              </div>
            </div>

            <!-- RF & Offsets -->
            <div class="space-y-3">
              <div class="text-xs text-zinc-500 font-mono font-bold">RF & CALIBRATION</div>
              <div>
                <label class="text-xs text-zinc-500 font-mono block mb-1">RF TX Power</label>
                <select id="flTxPower" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
                  <option value="0">-25.3 dBm</option>
                  <option value="1">-17.1 dBm</option>
                  <option value="2">-12.2 dBm</option>
                  <option value="3">-8.7 dBm</option>
                  <option value="4">-5.8 dBm</option>
                  <option value="5">-3.5 dBm</option>
                  <option value="6">-1.6 dBm</option>
                  <option value="7" selected>0 dBm (default)</option>
                  <option value="8">1.0 dBm</option>
                  <option value="9">1.6 dBm</option>
                  <option value="10">3.0 dBm</option>
                </select>
              </div>
              <div>
                <label class="text-xs text-zinc-500 font-mono block mb-1">Temperature Offset (°C × 100)</label>
                <input type="number" id="flTempOffset" value="0" min="-32768" max="32767" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
              </div>
              <div>
                <label class="text-xs text-zinc-500 font-mono block mb-1">Humidity Offset (% × 100)</label>
                <input type="number" id="flHumiOffset" value="0" min="-32768" max="32767" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
              </div>
            </div>
          </div>

          <!-- Flags row -->
          <div class="mt-4 pt-4 border-t border-zinc-800">
            <div class="text-xs text-zinc-500 font-mono font-bold mb-3">OPTIONS</div>
            <div class="flex flex-wrap gap-4">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="flFlagScreen" class="accent-amber-500">
                <span class="text-xs text-zinc-400 font-mono">Show on LCD</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="flFlagBt5" class="accent-amber-500">
                <span class="text-xs text-zinc-400 font-mono">BT5.0 Long Range</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="flFlagLpMeasure" class="accent-amber-500">
                <span class="text-xs text-zinc-400 font-mono">Low Power Measure</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="flFlagTempF" class="accent-amber-500">
                <span class="text-xs text-zinc-400 font-mono">Temp in °F on LCD</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Comfort Parameters -->
        <div id="flComfortSection" class="hidden bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <h3 class="font-mono font-bold text-amber-500 text-sm flex items-center gap-2 mb-4">
            <i data-lucide="smile" class="w-4 h-4"></i> Comfort Parameters
          </h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">Temp Min (°C×100)</label>
              <input type="number" id="flComfortTempMin" value="2000" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
            </div>
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">Temp Max (°C×100)</label>
              <input type="number" id="flComfortTempMax" value="2500" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
            </div>
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">Humi Min (%×100)</label>
              <input type="number" id="flComfortHumiMin" value="4000" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
            </div>
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">Humi Max (%×100)</label>
              <input type="number" id="flComfortHumiMax" value="6000" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
            </div>
          </div>
        </div>

        <!-- Trigger Configuration -->
        <div id="flTriggerSection" class="hidden bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <h3 class="font-mono font-bold text-amber-500 text-sm flex items-center gap-2 mb-4">
            <i data-lucide="bell-ring" class="w-4 h-4"></i> Trigger Configuration
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-3">
              <div class="text-xs text-zinc-500 font-mono font-bold">TEMPERATURE TRIGGER</div>
              <div>
                <label class="text-xs text-zinc-500 font-mono block mb-1">Temp Threshold (°C×100)</label>
                <input type="number" id="flTrigTempThreshold" value="0" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
              </div>
              <div>
                <label class="text-xs text-zinc-500 font-mono block mb-1">Temp Hysteresis</label>
                <input type="number" id="flTrigTempHyst" value="0" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
              </div>
            </div>
            <div class="space-y-3">
              <div class="text-xs text-zinc-500 font-mono font-bold">HUMIDITY TRIGGER</div>
              <div>
                <label class="text-xs text-zinc-500 font-mono block mb-1">Humi Threshold (%×100)</label>
                <input type="number" id="flTrigHumiThreshold" value="0" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
              </div>
              <div>
                <label class="text-xs text-zinc-500 font-mono block mb-1">Humi Hysteresis</label>
                <input type="number" id="flTrigHumiHyst" value="0" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
              </div>
            </div>
          </div>
          <div class="mt-3">
            <label class="text-xs text-zinc-500 font-mono block mb-1">Reed Switch Mode</label>
            <select id="flReedSwitch" class="w-full md:w-1/2 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
              <option value="0">None</option>
              <option value="1">Switch (GPIO)</option>
              <option value="2">Counter</option>
            </select>
          </div>
        </div>

        <!-- Mi Authorization -->
        <div id="flMiAuthSection" class="hidden bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <h3 class="font-mono font-bold text-amber-500 text-sm flex items-center gap-2 mb-4">
            <i data-lucide="shield" class="w-4 h-4"></i> Mi Authorization
          </h3>
          <p class="text-xs text-zinc-500 font-mono mb-4">Manage Xiaomi Mi token and bind key. Required for activation of sensors with original firmware.</p>
          <div class="space-y-3">
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">Mi Bind Key (hex)</label>
              <input type="text" id="flMiBindKey" placeholder="e.g. AABBCCDDEEFF11223344556677889900" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
            </div>
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">Mi Token (hex)</label>
              <input type="text" id="flMiToken" placeholder="Token from Mi activation" readonly class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-400 focus:outline-none">
            </div>
            <div class="flex gap-2 flex-wrap">
              <button onclick="flasherMiGetBindKey()" class="text-xs text-zinc-300 font-mono px-3 py-1.5 rounded-lg bg-zinc-700 hover:bg-zinc-600 transition-colors">Get Bind Key</button>
              <button onclick="flasherMiSetBindKey()" class="text-xs text-zinc-300 font-mono px-3 py-1.5 rounded-lg bg-zinc-700 hover:bg-zinc-600 transition-colors">Set Bind Key</button>
              <button onclick="flasherMiActivate()" class="text-xs text-amber-500 font-mono px-3 py-1.5 rounded-lg bg-amber-500/10 hover:bg-amber-500/20 transition-colors border border-amber-500/20">Activate</button>
            </div>
          </div>
        </div>

        <!-- Device Name / MAC / PinCode -->
        <div id="flDevMgmtSection" class="hidden bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <h3 class="font-mono font-bold text-amber-500 text-sm flex items-center gap-2 mb-4">
            <i data-lucide="tag" class="w-4 h-4"></i> Device Management
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">Device Name</label>
              <div class="flex gap-2">
                <input type="text" id="flDevName" placeholder="ATC_AABBCC" class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
                <button onclick="flasherSetDevName()" class="text-xs text-zinc-300 font-mono px-2 py-1 rounded bg-zinc-700 hover:bg-zinc-600 transition-colors">Set</button>
              </div>
            </div>
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">MAC Address</label>
              <div class="flex gap-2">
                <input type="text" id="flDevMAC" placeholder="AA:BB:CC:DD:EE:FF" class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
                <button onclick="flasherSetMAC()" class="text-xs text-zinc-300 font-mono px-2 py-1 rounded bg-zinc-700 hover:bg-zinc-600 transition-colors">Set</button>
              </div>
            </div>
            <div>
              <label class="text-xs text-zinc-500 font-mono block mb-1">Pin Code</label>
              <div class="flex gap-2">
                <input type="number" id="flPinCode" placeholder="0" min="0" max="999999" class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
                <button onclick="flasherSetPinCode()" class="text-xs text-zinc-300 font-mono px-2 py-1 rounded bg-zinc-700 hover:bg-zinc-600 transition-colors">Set</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Advanced OTA -->
        <div id="flOtaSection" class="hidden bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-mono font-bold text-amber-500 text-sm flex items-center gap-2">
              <i data-lucide="cpu" class="w-4 h-4"></i> OTA Firmware Update
            </h3>
            <button onclick="flasherLoadRemoteFw()" class="text-xs text-amber-500 hover:text-amber-400 font-mono px-2 py-1 rounded bg-amber-500/10 hover:bg-amber-500/20 transition-colors border border-amber-500/20 flex items-center gap-1">
              <i data-lucide="cloud-download" class="w-3 h-3"></i> Load from GitHub
            </button>
          </div>
          <div class="mb-3">
            <label class="text-xs text-zinc-500 font-mono block mb-1.5">Firmware Source</label>
            <select id="flFwSource" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-xs text-zinc-100 focus:border-amber-500 focus:outline-none">
              <option value="">— select or load firmware —</option>
            </select>
          </div>
          <div id="flAdvFileDrop" class="border-2 border-dashed border-zinc-700 rounded-lg p-6 text-center mb-3 cursor-pointer hover:border-amber-500/50 transition-colors">
            <input type="file" id="flAdvFwFile" accept=".bin" class="hidden">
            <i data-lucide="upload" class="w-6 h-6 text-zinc-500 mx-auto mb-2"></i>
            <p class="text-zinc-400 text-xs">Or drop <span class="font-mono text-amber-500">.bin</span> file here</p>
          </div>
          <div id="flAdvFwInfo" class="hidden bg-zinc-800 rounded-lg p-3 mb-3 font-mono text-xs space-y-1"></div>
          <div id="flAdvOtaProgress" class="hidden w-full h-3 bg-zinc-800 rounded-full overflow-hidden mb-3">
            <div id="flAdvOtaProgressFill" class="h-full bg-gradient-to-r from-amber-500 to-orange-500 rounded-full transition-all duration-100" style="width:0%"></div>
          </div>
          <div id="flAdvOtaStatus" class="text-center text-xs text-zinc-500 font-mono mb-3"></div>
          <button id="btnFlAdvFlash" disabled onclick="flasherStartOTA()" class="w-full bg-amber-500 hover:bg-amber-400 disabled:opacity-30 disabled:cursor-not-allowed text-zinc-900 font-mono font-bold px-4 py-2 rounded-lg transition-colors text-sm flex items-center justify-center gap-2">
            <i data-lucide="zap" class="w-4 h-4"></i> Flash Firmware
          </button>
        </div>

        <!-- Flasher Log -->
        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-mono font-bold text-amber-500 text-sm flex items-center gap-2">
              <i data-lucide="terminal" class="w-4 h-4"></i> Flasher Log
            </h3>
            <button onclick="clearFlasherLog()" class="text-xs text-zinc-500 hover:text-zinc-300 font-mono px-2 py-1 rounded bg-zinc-800 hover:bg-zinc-700 transition-colors">Clear</button>
          </div>
          <div id="flasherLog" class="bg-zinc-950 rounded-lg p-3 h-40 overflow-y-auto font-mono text-xs text-zinc-400 space-y-0.5 border border-zinc-800">
            <div class="text-zinc-600">Flasher ready. Connect a device to begin.</div>
          </div>
        </div>

      </div><!-- /flasherAdvanced -->
    </div>

    <!-- Settings Tab -->
    <div class="tab-content hidden" id="tab-settings">
      <div class="max-w-2xl mx-auto space-y-4">

        <!-- Thresholds -->
        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <h3 class="font-mono font-bold text-amber-500 text-sm mb-4 flex items-center gap-2">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i> Humidity Thresholds
          </h3>
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <label class="text-zinc-400 text-sm">Warning level (%)</label>
              <input type="number" id="setWarn" min="0" max="100" value="60" onchange="saveSettings()" class="w-24 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-sm text-zinc-100 text-right focus:border-amber-500 focus:outline-none">
            </div>
            <div class="flex items-center justify-between">
              <label class="text-zinc-400 text-sm">Critical level (%)</label>
              <input type="number" id="setCrit" min="0" max="100" value="80" onchange="saveSettings()" class="w-24 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-sm text-zinc-100 text-right focus:border-amber-500 focus:outline-none">
            </div>
          </div>
        </div>

        <!-- Sensor names -->
        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <h3 class="font-mono font-bold text-amber-500 text-sm mb-4 flex items-center gap-2">
            <i data-lucide="tag" class="w-4 h-4"></i> Sensor Names
          </h3>
          <div id="sensorNamesList">
            <p class="text-zinc-500 text-xs font-mono">Connect sensors to assign friendly names.</p>
          </div>
        </div>

        <!-- Data management -->
        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <h3 class="font-mono font-bold text-amber-500 text-sm mb-4 flex items-center gap-2">
            <i data-lucide="database" class="w-4 h-4"></i> Data Management
          </h3>
          <div class="flex items-center justify-between mb-4">
            <label class="text-zinc-400 text-sm">History retention (days)</label>
            <input type="number" id="setRetention" min="1" max="90" value="7" onchange="saveSettings()" class="w-24 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-sm text-zinc-100 text-right focus:border-amber-500 focus:outline-none">
          </div>
          <button onclick="clearHistory()" class="bg-red-500/20 hover:bg-red-500/30 text-red-400 font-mono font-bold text-xs px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Clear All History
          </button>
        </div>

      </div>
    </div>

    <!-- About Tab -->
    <div class="tab-content hidden" id="tab-about">
      <div class="max-w-2xl mx-auto space-y-4">

        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-6 text-center">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-amber-500/10 border border-amber-500/20 mb-4">
            <i data-lucide="thermometer" class="w-8 h-8 text-amber-500"></i>
          </div>
          <h2 class="font-mono font-bold text-2xl text-amber-500 mb-1">FSCMS</h2>
          <p class="text-zinc-400 text-sm font-mono mb-1">Fillament Storage Climate Monitoring System</p>
          <p class="text-zinc-500 text-xs font-mono" id="aboutVersion">v2.0 — Web Bluetooth Edition</p>
        </div>

        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <h3 class="font-mono font-bold text-amber-500 text-sm mb-3 flex items-center gap-2">
            <i data-lucide="info" class="w-4 h-4"></i> Overview
          </h3>
          <p class="text-xs text-zinc-400 font-mono leading-relaxed">
            FSCMS is a Progressive Web App for real-time monitoring of temperature and humidity inside 3D printer filament storage containers. It connects directly to Xiaomi Mijia LYWSD03MMC sensors via Web Bluetooth, supporting both original Xiaomi firmware and custom ATC firmware by PVVX.
          </p>
        </div>

        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <h3 class="font-mono font-bold text-amber-500 text-sm mb-3 flex items-center gap-2">
            <i data-lucide="cpu" class="w-4 h-4"></i> Features
          </h3>
          <div class="text-xs text-zinc-400 font-mono leading-relaxed space-y-2">
            <p><span class="text-amber-500">Live Dashboard</span> — Real-time temp, humidity, battery readings with color-coded status cards and battery profiles.</p>
            <p><span class="text-amber-500">Historical Charts</span> — 24-hour rolling charts with 0.2°C temperature resolution stored in IndexedDB.</p>
            <p><span class="text-amber-500">Smart Alerts</span> — Humidity threshold warnings (configurable), battery level monitoring (low at 20%, critical at 10%), push notifications, and full alert history.</p>
            <p><span class="text-amber-500">Flasher</span> — Simple one-click OTA firmware update and Advanced mode with full Telink Mi Flasher: device config, advertising type, Mi authorization, trigger/comfort settings, remote firmware loading from GitHub.</p>
            <p><span class="text-amber-500">Multi-sensor</span> — Auto-pair ATC devices, batch reconnect, persistent device memory, friendly name editing.</p>
            <p><span class="text-amber-500">BLE Debug</span> — Full performance logging with latency tracking, notification rates, connection diagnostics, and exportable logs.</p>
          </div>
        </div>

        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <h3 class="font-mono font-bold text-amber-500 text-sm mb-3 flex items-center gap-2">
            <i data-lucide="wrench" class="w-4 h-4"></i> Tech Stack
          </h3>
          <div class="grid grid-cols-2 gap-2 text-xs font-mono">
            <div class="bg-zinc-800/50 rounded-lg px-3 py-2">
              <span class="text-zinc-500">BLE</span>
              <span class="text-zinc-300 ml-2">Web Bluetooth API</span>
            </div>
            <div class="bg-zinc-800/50 rounded-lg px-3 py-2">
              <span class="text-zinc-500">Storage</span>
              <span class="text-zinc-300 ml-2">IndexedDB + localStorage</span>
            </div>
            <div class="bg-zinc-800/50 rounded-lg px-3 py-2">
              <span class="text-zinc-500">Charts</span>
              <span class="text-zinc-300 ml-2">Chart.js</span>
            </div>
            <div class="bg-zinc-800/50 rounded-lg px-3 py-2">
              <span class="text-zinc-500">UI</span>
              <span class="text-zinc-300 ml-2">Tailwind CSS</span>
            </div>
            <div class="bg-zinc-800/50 rounded-lg px-3 py-2">
              <span class="text-zinc-500">Icons</span>
              <span class="text-zinc-300 ml-2">Lucide</span>
            </div>
            <div class="bg-zinc-800/50 rounded-lg px-3 py-2">
              <span class="text-zinc-500">PWA</span>
              <span class="text-zinc-300 ml-2">Service Worker + Manifest</span>
            </div>
          </div>
        </div>

        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <h3 class="font-mono font-bold text-amber-500 text-sm mb-3 flex items-center gap-2">
            <i data-lucide="radio" class="w-4 h-4"></i> Compatible Devices
          </h3>
          <div class="text-xs text-zinc-400 font-mono leading-relaxed space-y-1.5">
            <p><span class="text-zinc-300">Xiaomi Mijia LYWSD03MMC</span> — Primary target (all board revisions B1.4 through B2.0)</p>
            <p><span class="text-zinc-300">Xiaomi MHO-C401</span> — E-ink display variant</p>
            <p><span class="text-zinc-300">Qingping CGG1-M</span> — Round display model</p>
            <p><span class="text-zinc-300">Xiaomi CGDK2</span> — Cleargrass clock</p>
            <p><span class="text-zinc-300">Xiaomi MHO-C122</span> — Small LCD model</p>
            <p><span class="text-zinc-300">Xiaomi MJWSD05MMC</span> — Newer LCD model</p>
            <p class="text-zinc-600 mt-2">All devices require ATC custom firmware or original Xiaomi firmware with BLE advertising enabled.</p>
          </div>
        </div>

        <div class="bg-zinc-900 border border-zinc-700 rounded-lg p-5">
          <h3 class="font-mono font-bold text-amber-500 text-sm mb-3 flex items-center gap-2">
            <i data-lucide="github" class="w-4 h-4"></i> Credits & Links
          </h3>
          <div class="text-xs text-zinc-400 font-mono leading-relaxed space-y-1.5">
            <p><span class="text-zinc-300">ATC Custom Firmware</span> — <a href="https://github.com/pvvx/ATC_MiThermometer" target="_blank" class="text-amber-500 hover:text-amber-400 underline underline-offset-2">pvvx/ATC_MiThermometer</a></p>
            <p><span class="text-zinc-300">Telink Mi Flasher</span> — <a href="https://pvvx.github.io/ATC_MiThermometer/TelinkMiFlasher.html" target="_blank" class="text-amber-500 hover:text-amber-400 underline underline-offset-2">Online Flasher Tool</a></p>
            <p><span class="text-zinc-300">FSCMS Source</span> — <a href="https://arnoutzw.github.io/mijia_monitor/" target="_blank" class="text-amber-500 hover:text-amber-400 underline underline-offset-2">arnoutzw.github.io/mijia_monitor</a></p>
          </div>
        </div>

        <div class="text-center py-4">
          <p class="text-xs text-zinc-600 font-mono">FSCMS <span id="aboutBuildHash">v2.0</span> — Made with Web Bluetooth</p>
        </div>

      </div>
    </div>

  </main>

<script>
/* ═══════════════════════════════════════════════
   FSCMS v2.0 — Fillament Storage Climate Monitoring System
   ═══════════════════════════════════════════════ */

const UUID_CUSTOM_SVC   = '00001f10-0000-1000-8000-00805f9b34fb';
const UUID_CUSTOM_CHAR  = '00001f1f-0000-1000-8000-00805f9b34fb';
const UUID_OTA_SVC      = '00010203-0405-0607-0809-0a0b0c0d1912';
const UUID_OTA_CHAR     = '00010203-0405-0607-0809-0a0b0c0d2b12';
const UUID_MI_SVC       = 'ebe0ccb0-7a0a-4b0c-8a1a-6ff2997da3a6';
const UUID_MI_TEMP_CHAR = 'ebe0ccc1-7a0a-4b0c-8a1a-6ff2997da3a6';

/* __BUILD_HASH__ is replaced by pre-commit hook with the short git commit hash */
const BUILD_HASH = '8f1ed47';

const BLE_OPTIONAL_SVCS = [
  UUID_CUSTOM_SVC, UUID_OTA_SVC, UUID_MI_SVC,
  '22210000-554a-4546-5542-46534450464d',
  0x180a, 0x181c, 0x181e, 0xfe95, 0x1f10, 0x1f11,
  0x181a, 0xfff9, 0xfdcd, 0xffe0, 0xfcd2
];

const HW_VERSIONS = [
  'LYWSD03MMC','MHO-C401(old)','CGG1-M(2020/21)','LYWSD03MMC','LYWSD03MMC',
  'LYWSD03MMC','CGDK2','CGG1-M(2022)','MHO-C401(2022)','MJWSD05MMC(ch)',
  'LYWSD03MMC','MHO-C122','MJWSD05MMC(en)'
];

const MAX_EXT_OTA_SIZE = 0x34000;

const sensors = {};
let settings = { warn: 60, crit: 80, retention: 7, names: {}, batteryProfile: 'balanced', bleMode: 'poll' };
// bleMode: 'poll' (connected + notifications) or 'advert' (passive BLE scan)
// batteryProfile: key into BATTERY_PROFILES — controls firmware config + client-side throttle
/* ── Battery Profiles ──
   Each profile sets firmware measure_interval, advertising_interval, and tx_power via cmd 0x55.
   measure_interval: seconds between sensor readings (byte 8)
   advInterval: BLE advertising interval in 0.625ms units (bytes 6-7), stored here in ms
   txPower: RF TX power register value (byte 9) — see FL_TX_POWERS
   storageRate: client-side throttle for IndexedDB storage (seconds)                       */
var BATTERY_PROFILES = {
  'realtime':   { label: 'Realtime',      measInterval: 4,   advInterval: 2500,  txPower: 7,  storageRate: 10,   desc: 'Max refresh, high battery drain' },
  'balanced':   { label: 'Balanced',      measInterval: 30,  advInterval: 5000,  txPower: 5,  storageRate: 30,   desc: 'Good responsiveness, moderate battery' },
  'battery':    { label: 'Battery Saver', measInterval: 120, advInterval: 10000, txPower: 3,  storageRate: 120,  desc: 'Extended battery life, 2-min updates' },
  'ultra':      { label: 'Ultra Saver',   measInterval: 255, advInterval: 20000, txPower: 0,  storageRate: 300,  desc: 'Maximum battery life, ~4-min updates' }
};
var DEFAULT_BATTERY_PROFILE = 'balanced';
var sensorLastPolled = {}; // { sensorId: timestamp ms }
var advScanActive = false;  // is BLE advertisement scanning running?
var advScanAbort = null;    // AbortController for stopping scan
let knownDevices = {};  // { deviceId: { deviceName, lastSeen } } — persisted in localStorage
let alertCooldowns = {};
var battLowCount = {};     // { sensorId: consecutiveFramesBelowThreshold }
var battAlertCooldowns = {}; // { sensorId: timestamp } — separate cooldown for battery alerts
var alertHistory = [];  // { msg, type, time }
var alertUnread = 0;
let firmwareData = null;
let firmwareInfo = null;
let otaInProgress = false;
let db = null;

/* ── BLE Performance Logger ── */
var blePerf = {
  log: [],
  maxEntries: 500,
  sensorStats: {},  // per-sensor notification stats
  add: function(category, label, durationMs, extra) {
    var entry = {
      t: new Date().toISOString().substr(11, 12),
      ts: performance.now(),
      cat: category,
      label: label,
      ms: durationMs !== null ? Math.round(durationMs * 100) / 100 : null,
      extra: extra || null
    };
    this.log.push(entry);
    if (this.log.length > this.maxEntries) this.log.shift();
    // Console output with color coding
    var color = durationMs > 2000 ? 'color:#ef4444;font-weight:bold'  // red >2s
              : durationMs > 500  ? 'color:#f59e0b;font-weight:bold'  // amber >500ms
              : durationMs > 100  ? 'color:#eab308'                   // yellow >100ms
              : 'color:#22c55e';                                       // green
    var durStr = durationMs !== null ? ' [' + durationMs.toFixed(1) + 'ms]' : '';
    var extraStr = extra ? ' ' + JSON.stringify(extra) : '';
    console.log('%c[BLE:' + category + '] ' + label + durStr + extraStr, color);
    this.renderPanel();
  },
  trackNotification: function(sensorId) {
    var now = performance.now();
    if (!this.sensorStats[sensorId]) {
      this.sensorStats[sensorId] = { count: 0, first: now, last: now, intervals: [] };
    }
    var st = this.sensorStats[sensorId];
    if (st.count > 0) {
      st.intervals.push(now - st.last);
      if (st.intervals.length > 50) st.intervals.shift();
    }
    st.count++;
    st.last = now;
  },
  getSensorRate: function(sensorId) {
    var st = this.sensorStats[sensorId];
    if (!st || st.intervals.length === 0) return null;
    var sum = st.intervals.reduce(function(a, b) { return a + b; }, 0);
    var avg = sum / st.intervals.length;
    var min = Math.min.apply(null, st.intervals);
    var max = Math.max.apply(null, st.intervals);
    return { avgMs: Math.round(avg), minMs: Math.round(min), maxMs: Math.round(max), count: st.count };
  },
  clear: function() {
    this.log = [];
    this.sensorStats = {};
    this.renderPanel();
    console.log('%c[BLE] Performance log cleared', 'color:#71717a');
  },
  renderPanel: function() {
    var el = document.getElementById('blePerfLog');
    if (!el) return;
    var recent = this.log.slice(-30).reverse();
    var html = recent.map(function(e) {
      var cls = e.ms > 2000 ? 'text-red-400' : e.ms > 500 ? 'text-amber-400' : e.ms > 100 ? 'text-yellow-400' : 'text-green-400';
      var dur = e.ms !== null ? '<span class="' + cls + '">' + e.ms.toFixed(1) + 'ms</span>' : '';
      var ex = e.extra ? ' <span class="text-zinc-600">' + JSON.stringify(e.extra) + '</span>' : '';
      return '<div class="flex gap-2 items-baseline"><span class="text-zinc-600 shrink-0">' + e.t + '</span>' +
        '<span class="text-zinc-500 shrink-0 w-14">[' + e.cat + ']</span>' +
        '<span class="text-zinc-300 flex-1">' + e.label + '</span>' +
        '<span class="shrink-0 tabular-nums">' + dur + '</span>' + ex + '</div>';
    }).join('');
    el.innerHTML = html || '<div class="text-zinc-600">No BLE activity yet.</div>';
    // Update sensor rate stats
    var rateEl = document.getElementById('blePerfRates');
    if (rateEl) {
      var rateHtml = '';
      var self = this;
      Object.keys(this.sensorStats).forEach(function(sid) {
        var r = self.getSensorRate(sid);
        if (!r) return;
        var name = settings.names[sid] || (sensors[sid] ? sensors[sid].name : sid.substr(0, 12));
        rateHtml += '<div class="flex justify-between"><span class="text-zinc-400">' + esc(name) + '</span>' +
          '<span class="text-zinc-300">' + r.count + ' msgs, avg ' + r.avgMs + 'ms, min ' + r.minMs + 'ms, max ' + r.maxMs + 'ms</span></div>';
      });
      rateEl.innerHTML = rateHtml || '<div class="text-zinc-600">No notifications yet.</div>';
    }
  }
};

// Helper: time an async operation
async function bleTimed(category, label, fn, extra) {
  var t0 = performance.now();
  try {
    var result = await fn();
    blePerf.add(category, label, performance.now() - t0, extra);
    return result;
  } catch (err) {
    blePerf.add(category, label + ' FAILED: ' + err.message, performance.now() - t0, extra);
    throw err;
  }
}

/* ── Known Devices Persistence ── */
function loadKnownDevices() {
  try {
    var d = JSON.parse(localStorage.getItem('filamon_devices'));
    if (d) knownDevices = d;
  } catch (e) {}
}

function saveKnownDevice(id, deviceName) {
  knownDevices[id] = { deviceName: deviceName || id, lastSeen: Date.now() };
  localStorage.setItem('filamon_devices', JSON.stringify(knownDevices));
}

function showForgetConfirm(id) {
  var name = settings.names[id] || (knownDevices[id] ? knownDevices[id].deviceName : id);
  document.getElementById('forgetDeviceName').textContent = name;
  document.getElementById('forgetDeviceId').textContent = id;
  document.getElementById('forgetModal').dataset.deviceId = id;
  document.getElementById('forgetModal').classList.remove('hidden');
  lucide.createIcons();
}
function closeForgetModal() {
  document.getElementById('forgetModal').classList.add('hidden');
}
function confirmForgetDevice() {
  var id = document.getElementById('forgetModal').dataset.deviceId;
  // Disconnect if connected
  if (sensors[id] && sensors[id].server) {
    try { sensors[id].server.disconnect(); } catch (e) {}
  }
  delete sensors[id];
  // Wipe from known devices + settings
  delete knownDevices[id];
  delete settings.names[id];
  localStorage.setItem('filamon_devices', JSON.stringify(knownDevices));
  saveSettings();
  // Wipe IndexedDB history for this sensor
  if (db) {
    try {
      var tx = db.transaction('history', 'readwrite');
      var store = tx.objectStore('history');
      var idx = store.index('sensor');
      var req = idx.openCursor(IDBKeyRange.only(id));
      var deleted = 0;
      req.onsuccess = function(e) {
        var cursor = e.target.result;
        if (cursor) { cursor.delete(); deleted++; cursor.continue(); }
        else { blePerf.add('FORGET', 'Wiped ' + deleted + ' history records for ' + id, null); }
      };
    } catch (e) {}
  }
  // Wipe perf stats
  delete blePerf.sensorStats[id];
  closeForgetModal();
  renderDashboard();
  updateSensorNamesList();
  updateOTADeviceList();
  blePerf.add('FORGET', 'Device forgotten: ' + id, null);
}

/* ── Batched Sequential Auto-Reconnect ── */
var batchReconnectActive = false;

async function batchReconnect() {
  if (batchReconnectActive) { showAlert('Reconnect already in progress...', 'warn'); return; }
  if (!navigator.bluetooth || !navigator.bluetooth.getDevices) {
    showAlert('getDevices() not supported — use individual Reconnect buttons.', 'error');
    blePerf.add('RECONN', 'getDevices() not supported', null);
    return;
  }

  batchReconnectActive = true;
  var batchStart = performance.now();
  updateConnectionStatus('connecting');
  updateReconnectButton(true);

  try {
    // Step 1: Get all previously paired BLE device objects from browser
    var allDevices = await bleTimed('RECONN', 'getDevices()', function() {
      return navigator.bluetooth.getDevices();
    });

    var knownIds = Object.keys(knownDevices);
    var pairedDevices = allDevices.filter(function(d) {
      return knownIds.indexOf(d.id) !== -1;
    });

    // Filter to only disconnected ones
    var pending = pairedDevices.filter(function(d) {
      return !sensors[d.id] || !sensors[d.id].server;
    });

    blePerf.add('RECONN', 'Batch start: ' + pending.length + ' disconnected of ' + pairedDevices.length + ' paired (' + knownIds.length + ' saved)', null);

    if (pending.length === 0) {
      showAlert('All saved devices are already connected.', 'success');
      batchReconnectActive = false;
      updateConnectionStatus(getOverallStatus());
      updateReconnectButton(false);
      return;
    }

    // Step 2: Connect sequentially with delay between each
    var succeeded = 0;
    var failed = 0;
    var DELAY_BETWEEN_MS = 2000;

    for (var i = 0; i < pending.length; i++) {
      if (!batchReconnectActive) break; // allow cancellation

      var dev = pending[i];
      var devLabel = dev.name || dev.id.substr(0, 12);
      showAlert('Connecting ' + (i + 1) + '/' + pending.length + ': ' + devLabel + '...');

      try {
        await connectDevice(dev, true);
        succeeded++;
        blePerf.add('RECONN', 'Batch OK: ' + devLabel + ' (' + (i + 1) + '/' + pending.length + ')', null);
      } catch (err) {
        failed++;
        blePerf.add('RECONN', 'Batch FAIL: ' + devLabel + ' — ' + err.message, null);
      }

      // Cooldown between devices to avoid BLE overload
      if (i < pending.length - 1) {
        await delay(DELAY_BETWEEN_MS);
      }
    }

    blePerf.add('RECONN', 'Batch complete', performance.now() - batchStart, {
      ok: succeeded, fail: failed, total: pending.length
    });
    showAlert('Reconnect done: ' + succeeded + ' connected, ' + failed + ' failed of ' + pending.length, failed === 0 ? 'success' : 'warn');
  } catch (err) {
    blePerf.add('RECONN', 'Batch error: ' + err.message, performance.now() - batchStart);
    showAlert('Reconnect error: ' + err.message, 'error');
  } finally {
    batchReconnectActive = false;
    updateConnectionStatus(getOverallStatus());
    updateReconnectButton(false);
    renderDashboard();
  }
}

function cancelBatchReconnect() {
  if (batchReconnectActive) {
    batchReconnectActive = false;
    showAlert('Reconnect cancelled.', 'warn');
    blePerf.add('RECONN', 'Batch cancelled by user', null);
  }
}

function updateReconnectButton(active) {
  var btn = document.getElementById('btnReconnectAll');
  if (!btn) return;
  if (active) {
    btn.innerHTML = '<i data-lucide="loader" class="w-3.5 h-3.5 animate-spin"></i> Cancel';
    btn.onclick = cancelBatchReconnect;
    btn.className = 'bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/30 text-xs font-mono px-3 py-2 rounded-lg transition-colors flex items-center gap-1.5';
  } else {
    btn.innerHTML = '<i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i> Reconnect All';
    btn.onclick = batchReconnect;
    btn.className = 'bg-zinc-700 hover:bg-zinc-600 text-zinc-400 text-xs font-mono px-3 py-2 rounded-lg transition-colors flex items-center gap-1.5';
  }
  lucide.createIcons();
}

/* ── IndexedDB ── */
function openDB() {
  return new Promise(function(resolve, reject) {
    var req = indexedDB.open('FilaMonDB', 1);
    req.onupgradeneeded = function(e) {
      var d = e.target.result;
      if (!d.objectStoreNames.contains('history')) {
        var store = d.createObjectStore('history', { autoIncrement: true });
        store.createIndex('sensor', 'sensor', { unique: false });
        store.createIndex('time', 'time', { unique: false });
      }
    };
    req.onsuccess = function() { db = req.result; resolve(db); };
    req.onerror = function() { reject(req.error); };
  });
}

function storeReading(sensorId, temp, humi, batt) {
  if (!db) return;
  var tx = db.transaction('history', 'readwrite');
  tx.objectStore('history').add({ sensor: sensorId, time: Date.now(), temp: temp, humi: humi, batt: batt });
}

function getHistory(sensorId, hours) {
  hours = hours || 24;
  return new Promise(function(resolve) {
    if (!db) return resolve([]);
    var since = Date.now() - hours * 3600000;
    var tx = db.transaction('history', 'readonly');
    var idx = tx.objectStore('history').index('sensor');
    var results = [];
    var req = idx.openCursor(IDBKeyRange.only(sensorId));
    req.onsuccess = function(e) {
      var cursor = e.target.result;
      if (cursor) {
        if (cursor.value.time >= since) results.push(cursor.value);
        cursor.continue();
      } else resolve(results);
    };
    req.onerror = function() { resolve([]); };
  });
}

function cleanOldData() {
  if (!db) return;
  var cutoff = Date.now() - settings.retention * 86400000;
  var tx = db.transaction('history', 'readwrite');
  var store = tx.objectStore('history');
  var idx = store.index('time');
  var req = idx.openCursor(IDBKeyRange.upperBound(cutoff));
  req.onsuccess = function(e) {
    var cursor = e.target.result;
    if (cursor) { cursor.delete(); cursor.continue(); }
  };
}

/* ── Settings ── */
function loadSettings() {
  try {
    var s = JSON.parse(localStorage.getItem('filamon_settings'));
    if (s) settings = Object.assign({}, settings, s);
  } catch (e) {}
  if (!settings.names) settings.names = {};
  if (!settings.batteryProfile) settings.batteryProfile = DEFAULT_BATTERY_PROFILE;
  delete settings.pollRates; // migrate from old poll rate system
  if (!settings.bleMode) settings.bleMode = 'poll';
  document.getElementById('setWarn').value = settings.warn;
  document.getElementById('setCrit').value = settings.crit;
  document.getElementById('setRetention').value = settings.retention;
  updateBleModeUI();
  renderBatteryProfiles();
}

function saveSettings() {
  settings.warn = parseInt(document.getElementById('setWarn').value) || 60;
  settings.crit = parseInt(document.getElementById('setCrit').value) || 80;
  settings.retention = parseInt(document.getElementById('setRetention').value) || 7;
  localStorage.setItem('filamon_settings', JSON.stringify(settings));
  renderDashboard();
}

function clearHistory() {
  if (!confirm('Clear all historical data?')) return;
  if (!db) return;
  var tx = db.transaction('history', 'readwrite');
  tx.objectStore('history').clear();
  Object.values(sensors).forEach(function(s) { if (s.chart) { s.chart.destroy(); s.chart = null; } });
  renderCharts();
}

/* ── BLE Connection ── */
var autoPairActive = false;

async function autoPairATC() {
  if (!navigator.bluetooth) {
    alert('Web Bluetooth is not supported in this browser. Use Chrome, Edge, or Opera.');
    return;
  }
  autoPairActive = true;
  var paired = 0;
  showAlert('Auto Pair: select each ATC_ sensor in the picker. Cancel when done.');

  while (autoPairActive) {
    try {
      var device = await navigator.bluetooth.requestDevice({
        filters: [{ namePrefix: 'ATC_' }],
        optionalServices: BLE_OPTIONAL_SVCS
      });
      // Skip if already connected
      if (sensors[device.id] && sensors[device.id].server) {
        showAlert('Already connected: ' + (device.name || device.id), 'warn');
        continue;
      }
      await connectDevice(device, false);
      paired++;
      showAlert('Paired ' + paired + ' sensor(s). Select next or cancel picker to finish.', 'success');
    } catch (err) {
      // User cancelled the picker — stop looping
      autoPairActive = false;
      if (paired > 0) {
        showAlert('Auto Pair complete: ' + paired + ' sensor(s) paired.', 'success');
      }
      break;
    }
  }
  autoPairActive = false;
}

async function scanAndConnect() {
  if (!navigator.bluetooth) {
    alert('Web Bluetooth is not supported in this browser. Use Chrome, Edge, or Opera.');
    return;
  }
  try {
    var device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: 'ATC_' }],
      optionalServices: BLE_OPTIONAL_SVCS
    });
    await connectDevice(device);
  } catch (err) {
    if (err.name !== 'NotFoundError') {
      console.error('BLE scan error:', err);
      alert('Connection failed: ' + err.message);
    }
  }
}

async function connectDevice(device, silent) {
  var id = device.id || device.name || ('dev_' + Date.now());
  var devLabel = device.name || id.substr(0, 12);
  var connectStart = performance.now();
  updateConnectionStatus('connecting');
  blePerf.add('CONN', 'Connect started: ' + devLabel, null, { id: id });

  try {
    device.addEventListener('gattserverdisconnected', function() { onDisconnect(id); });

    var server = await bleTimed('GATT', 'gatt.connect() ' + devLabel, function() {
      return device.gatt.connect();
    });

    var sensorData = {
      device: device, server: server, id: id,
      name: settings.names[id] || device.name || 'Sensor',
      customChar: null, otaChar: null, miTempChar: null,
      temp: null, humi: null, batt: null, vbat: null,
      count: 0, lastUpdate: null, chart: null,
      hwVer: null, swVer: null, hwName: null, cfg: null
    };

    // Detect compatible services — reject incompatible devices
    var hasCustom = false;
    var hasMi = false;

    try {
      var customSvc = await bleTimed('SVC', 'getPrimaryService(custom) ' + devLabel, function() {
        return server.getPrimaryService(UUID_CUSTOM_SVC);
      });
      var customChar = await bleTimed('CHAR', 'getCharacteristic(custom) ' + devLabel, function() {
        return customSvc.getCharacteristic(UUID_CUSTOM_CHAR);
      });
      sensorData.customChar = customChar;
      hasCustom = true;
      await bleTimed('NOTIF', 'startNotifications(custom) ' + devLabel, function() {
        return customChar.startNotifications();
      });
      customChar.addEventListener('characteristicvaluechanged', function(e) { onCustomNotification(id, e); });
      await bleTimed('WRITE', 'writeValue(0x33 poll cmd) ' + devLabel, function() {
        return customChar.writeValue(new Uint8Array([0x33, 0xC8]));
      });
    } catch (e) {
      blePerf.add('SVC', 'Custom service not found: ' + devLabel, null);
    }

    if (!hasCustom) {
      try {
        var miSvc = await bleTimed('SVC', 'getPrimaryService(mi) ' + devLabel, function() {
          return server.getPrimaryService(UUID_MI_SVC);
        });
        var miChar = await bleTimed('CHAR', 'getCharacteristic(mi_temp) ' + devLabel, function() {
          return miSvc.getCharacteristic(UUID_MI_TEMP_CHAR);
        });
        sensorData.miTempChar = miChar;
        hasMi = true;
        await bleTimed('NOTIF', 'startNotifications(mi) ' + devLabel, function() {
          return miChar.startNotifications();
        });
        miChar.addEventListener('characteristicvaluechanged', function(e) { onMiNotification(id, e); });
      } catch (e2) {
        blePerf.add('SVC', 'Mi service not found: ' + devLabel, null);
      }
    }

    // If neither ATC custom nor Mi temp service found → incompatible device
    if (!hasCustom && !hasMi) {
      try { server.disconnect(); } catch (dc) {}
      blePerf.add('CONN', 'REJECTED incompatible: ' + devLabel, performance.now() - connectStart);
      updateConnectionStatus(getOverallStatus());
      if (!silent) alert('Incompatible device: "' + (device.name || id) + '"\n\nNo Mijia / ATC temperature service found.\nOnly LYWSD03MMC and compatible sensors with ATC or original firmware are supported.');
      return;
    }

    try {
      var otaSvc = await bleTimed('SVC', 'getPrimaryService(ota) ' + devLabel, function() {
        return server.getPrimaryService(UUID_OTA_SVC);
      });
      var otaChar = await bleTimed('CHAR', 'getCharacteristic(ota) ' + devLabel, function() {
        return otaSvc.getCharacteristic(UUID_OTA_CHAR);
      });
      sensorData.otaChar = otaChar;
    } catch (e3) {
      blePerf.add('SVC', 'OTA service not available: ' + devLabel, null);
    }

    sensors[id] = sensorData;
    saveKnownDevice(id, device.name);
    updateConnectionStatus('connected');
    updateOTADeviceList();
    updateSensorNamesList();
    renderDashboard();

    if (hasCustom && sensorData.customChar) {
      try {
        await bleTimed('WRITE', 'writeValue(0x55 hw query) ' + devLabel, function() {
          return sensorData.customChar.writeValue(new Uint8Array([0x55]));
        });
      } catch (ec) {}

      // Auto-apply battery profile to newly connected sensor
      try {
        var bp = BATTERY_PROFILES[settings.batteryProfile];
        if (bp) {
          await new Promise(function(r) { setTimeout(r, 300); });
          var cmd = new Uint8Array(14);
          cmd[0] = 0x55;
          cmd[1] = 0x41; // custom adv type + lp_measures
          var dv = new DataView(cmd.buffer);
          dv.setInt16(2, 0, true);
          dv.setInt16(4, 0, true);
          dv.setUint16(6, Math.round(bp.advInterval / 0.625), true);
          cmd[8] = Math.min(255, bp.measInterval);
          cmd[9] = bp.txPower;
          dv.setUint16(10, 0, true);
          cmd[12] = 0;
          cmd[13] = 0;
          await sensorData.customChar.writeValue(cmd);
          blePerf.add('PROFILE', 'Auto-applied "' + bp.label + '" to ' + devLabel, null);
        }
      } catch (ep) {
        blePerf.add('PROFILE', 'Auto-apply failed on ' + devLabel + ': ' + ep.message, null);
      }
    }

    blePerf.add('CONN', 'COMPLETE: ' + devLabel, performance.now() - connectStart, {
      custom: hasCustom, mi: hasMi, ota: !!sensorData.otaChar
    });

  } catch (err) {
    blePerf.add('CONN', 'FAILED: ' + devLabel + ' — ' + err.message, performance.now() - connectStart);
    console.error('Connect error:', err);
    if (!silent) alert('Failed to connect: ' + err.message);
    updateConnectionStatus(getOverallStatus());
  }
}

function getOverallStatus() {
  return Object.values(sensors).some(function(s) { return !!s.server; }) ? 'connected' : 'disconnected';
}

function onDisconnect(sensorId) {
  var s = sensors[sensorId];
  if (s) { s.server = null; s.customChar = null; s.otaChar = null; s.miTempChar = null; }
  updateConnectionStatus(getOverallStatus());
  updateOTADeviceList();
  renderDashboard();
}

async function reconnectByName(bleName) {
  if (!navigator.bluetooth) { alert('Web Bluetooth not supported.'); return; }
  blePerf.add('RECONN', 'Reconnect by name: ' + bleName, null);
  try {
    var device = await navigator.bluetooth.requestDevice({
      filters: [{ name: bleName }],
      optionalServices: BLE_OPTIONAL_SVCS
    });
    await connectDevice(device, false);
  } catch (err) {
    if (err.name !== 'NotFoundError') {
      blePerf.add('RECONN', 'Reconnect failed: ' + bleName + ' — ' + err.message, null);
      alert('Reconnect failed: ' + err.message);
    }
    updateConnectionStatus(getOverallStatus());
  }
}

/* ── BLE Notifications ── */
function onCustomNotification(sensorId, event) {
  var value = event.target.value;
  var blkid = value.getUint8(0);
  var len = value.byteLength;
  blePerf.trackNotification(sensorId);

  if (blkid === 0x33 && len >= 8) {
    // Throttle: firmware pushes 0x33 every ~4-10s on its own.
    // Only process + store when the poll interval has elapsed.
    // Always update live readings (temp/humi/batt) for the card,
    // but only store to IndexedDB and trigger alerts at poll rate.
    var vbat = value.getUint16(1, true);
    var temp = roundTemp(value.getInt16(3, true) / 100.0);
    var humi = roundHumi(value.getUint16(5, true) / 100.0);
    var count = value.getUint16(7, true);
    var s = sensors[sensorId];
    if (!s) return;
    s.temp = temp; s.humi = humi; s.vbat = vbat;
    s.batt = vbatToPercent(vbat); s.count = count;
    s.lastUpdate = new Date();

    var now = Date.now();
    var profile = BATTERY_PROFILES[settings.batteryProfile] || BATTERY_PROFILES['balanced'];
    var rate = profile.storageRate * 1000;
    var lastStored = sensorLastPolled[sensorId] || 0;

    if (now - lastStored >= rate) {
      // Poll interval elapsed → store, alert, log
      sensorLastPolled[sensorId] = now;
      var notifRate = blePerf.getSensorRate(sensorId);
      blePerf.add('DATA', 'Custom 0x33 ' + (settings.names[sensorId] || sensorId.substr(0, 8)), null, {
        temp: temp.toFixed(2), humi: humi.toFixed(1), batt: s.batt + '%',
        interval: notifRate ? notifRate.avgMs + 'ms' : 'first'
      });
      storeReading(sensorId, temp, humi, s.batt);
      checkAlerts(sensorId, humi);
      checkBatteryAlerts(sensorId, s.batt);
    }
    // Always re-render dashboard so live card shows current values
    renderDashboard();
  } else if (blkid === 0x55 && len >= 3) {
    var s2 = sensors[sensorId];
    if (!s2) return;
    s2.hwVer = value.getUint8(1);
    s2.swVer = value.getUint8(2);
    if (s2.hwVer < HW_VERSIONS.length) s2.hwName = HW_VERSIONS[s2.hwVer];
    blePerf.add('DATA', 'HW info 0x55 ' + (settings.names[sensorId] || sensorId.substr(0, 8)), null, {
      hw: s2.hwVer, sw: s2.swVer, name: s2.hwName
    });
    renderDashboard();
  } else {
    blePerf.add('DATA', 'Unknown cmd 0x' + blkid.toString(16) + ' len=' + len + ' ' + sensorId.substr(0, 8), null);
  }
}

function onMiNotification(sensorId, event) {
  var value = event.target.value;
  if (value.byteLength < 5) return;
  blePerf.trackNotification(sensorId);
  var temp = roundTemp(value.getInt16(0, true) / 100.0);
  var hum = roundHumi(value.getUint8(2));
  var vbat = value.getUint16(3, true);
  var s = sensors[sensorId];
  if (!s) return;
  // Always update live card values
  s.temp = temp; s.humi = hum; s.vbat = vbat;
  s.batt = vbatToPercent(vbat); s.lastUpdate = new Date();

  // Throttle storage & alerts to match battery profile
  var now = Date.now();
  var profile = BATTERY_PROFILES[settings.batteryProfile] || BATTERY_PROFILES['balanced'];
  var rate = profile.storageRate * 1000;
  var lastStored = sensorLastPolled[sensorId] || 0;

  if (now - lastStored >= rate) {
    sensorLastPolled[sensorId] = now;
    var perfRate = blePerf.getSensorRate(sensorId);
    blePerf.add('DATA', 'Mi notif ' + (settings.names[sensorId] || sensorId.substr(0, 8)), null, {
      temp: temp.toFixed(2), humi: hum, batt: s.batt + '%',
      interval: perfRate ? perfRate.avgMs + 'ms' : 'first'
    });
    storeReading(sensorId, temp, hum, s.batt);
    checkAlerts(sensorId, hum);
    checkBatteryAlerts(sensorId, s.batt);
  }
  // Always re-render dashboard so live card shows current values
  renderDashboard();
}

function roundTemp(v) { return Math.round(v * 10) / 10; }   // 0.1°C — matches SHT4x ±0.2°C accuracy
function roundHumi(v) { return Math.round(v); }              // 1% RH — matches SHT4x ±1.8% accuracy

function vbatToPercent(mv) {
  var pct = Math.round(((mv / 1000) - 2.1) / (3.1 - 2.1) * 100);
  return Math.max(0, Math.min(100, pct));
}

/* ── BLE Mode Toggle: Poll vs Advertisement ── */
function toggleBleMode() {
  var newMode = settings.bleMode === 'poll' ? 'advert' : 'poll';
  setBleMode(newMode);
}

function setBleMode(mode) {
  settings.bleMode = mode;
  saveSettings();
  updateBleModeUI();

  if (mode === 'advert') {
    startAdvertScan();
  } else {
    stopAdvertScan();
  }
  blePerf.add('MODE', 'BLE mode → ' + mode, null);
}

function updateBleModeUI() {
  var sw = document.getElementById('bleModeSwitch');
  var dot = document.getElementById('bleModeDot');
  var label = document.getElementById('bleModeLabel');
  var label2 = document.getElementById('bleModeLabel2');
  if (!sw) return;

  if (settings.bleMode === 'advert') {
    sw.className = 'relative w-9 h-5 rounded-full transition-colors bg-amber-500';
    dot.className = 'absolute top-0.5 left-[18px] w-4 h-4 rounded-full bg-zinc-900 transition-all duration-200';
    if (label) label.className = 'text-[10px] font-mono text-zinc-500 hidden sm:inline';
    if (label2) label2.className = 'text-[10px] font-mono text-amber-400 hidden sm:inline';
  } else {
    sw.className = 'relative w-9 h-5 rounded-full transition-colors bg-zinc-600';
    dot.className = 'absolute top-0.5 left-0.5 w-4 h-4 rounded-full bg-zinc-300 transition-all duration-200';
    if (label) label.className = 'text-[10px] font-mono text-zinc-300 hidden sm:inline';
    if (label2) label2.className = 'text-[10px] font-mono text-zinc-500 hidden sm:inline';
  }
}

var advWatchedDevices = []; // devices with active watchAdvertisements()

async function startAdvertScan() {
  if (advScanActive) return;

  if (!navigator.bluetooth) {
    showAlert('Web Bluetooth not supported', 'error');
    settings.bleMode = 'poll'; saveSettings(); updateBleModeUI();
    return;
  }

  blePerf.add('ADV', 'Starting advertisement watch...', null);
  advWatchedDevices = [];
  var watchCount = 0;

  // Strategy 1: Watch already-connected sensor device objects
  var sensorList = Object.values(sensors);
  blePerf.add('ADV', 'Active sensors: ' + sensorList.length, null);
  for (var i = 0; i < sensorList.length; i++) {
    var s = sensorList[i];
    var dev = s.device;
    if (!dev) { blePerf.add('ADV', 'Sensor ' + s.id.substr(0,8) + ' has no device object', null); continue; }
    if (!dev.watchAdvertisements) { blePerf.add('ADV', 'Device ' + (dev.name || dev.id) + ' lacks watchAdvertisements', null); continue; }
    try {
      dev.addEventListener('advertisementreceived', onAdvertReceived);
      await dev.watchAdvertisements();
      advWatchedDevices.push({ device: dev });
      watchCount++;
      blePerf.add('ADV', 'Watching: ' + (dev.name || dev.id.substr(0, 8)), null);
    } catch (e) {
      blePerf.add('ADV', 'watchAdvertisements failed on ' + (dev.name || dev.id) + ': ' + e.message, null);
    }
  }

  // Strategy 2: Use getDevices() for previously paired but not yet connected
  if (navigator.bluetooth.getDevices) {
    try {
      var pairedDevices = await navigator.bluetooth.getDevices();
      blePerf.add('ADV', 'getDevices() returned ' + pairedDevices.length + ' device(s)', null);
      var alreadyWatching = advWatchedDevices.map(function(w) { return w.device.id; });

      for (var j = 0; j < pairedDevices.length; j++) {
        var pd = pairedDevices[j];
        if (alreadyWatching.indexOf(pd.id) !== -1) continue;
        if (!pd.watchAdvertisements) { blePerf.add('ADV', 'Paired device ' + (pd.name || pd.id) + ' lacks watchAdvertisements', null); continue; }

        try {
          pd.addEventListener('advertisementreceived', onAdvertReceived);
          await pd.watchAdvertisements();
          advWatchedDevices.push({ device: pd });
          watchCount++;
          blePerf.add('ADV', 'Watching (paired): ' + (pd.name || pd.id.substr(0, 8)), null);
        } catch (e2) {
          blePerf.add('ADV', 'watchAdvertisements failed on paired ' + (pd.name || pd.id) + ': ' + e2.message, null);
        }
      }
    } catch (e3) {
      blePerf.add('ADV', 'getDevices() failed: ' + e3.message, null);
    }
  } else {
    blePerf.add('ADV', 'getDevices() not available in this browser', null);
  }

  // Strategy 3: Fallback to requestLEScan if watchAdvertisements found nothing
  if (watchCount === 0 && navigator.bluetooth.requestLEScan) {
    try {
      blePerf.add('ADV', 'No watched devices yet, trying requestLEScan fallback...', null);
      advScanAbort = new AbortController();
      await navigator.bluetooth.requestLEScan({
        filters: [{ namePrefix: 'ATC_' }],
        keepRepeatedDevices: true
      }, { signal: advScanAbort.signal });
      navigator.bluetooth.addEventListener('advertisementreceived', onAdvertReceived);
      watchCount++;
      blePerf.add('ADV', 'requestLEScan active (fallback)', null);
    } catch (e4) {
      blePerf.add('ADV', 'requestLEScan fallback failed: ' + e4.message, null);
    }
  }

  if (watchCount === 0) {
    var hasAnyApi = navigator.bluetooth.requestLEScan || navigator.bluetooth.getDevices ||
      Object.values(sensors).some(function(s) { return s.device && s.device.watchAdvertisements; });
    if (!hasAnyApi) {
      showAlert('Advertisement mode requires experimental Chrome flags. Enable "Experimental Web Platform features" at chrome://flags', 'error');
      blePerf.add('ADV', 'No BLE scanning APIs available — enable chrome://flags/#enable-experimental-web-platform-features', null);
    } else {
      showAlert('No devices available for advertisement watching. Connect sensors in Poll mode first, then switch to Advert.', 'warn');
      blePerf.add('ADV', 'No devices could be watched', null);
    }
    settings.bleMode = 'poll'; saveSettings(); updateBleModeUI();
    return;
  }

  advScanActive = true;
  showAlert('Advertisement watching active — ' + watchCount + ' device(s) in passive mode', 'success');
  blePerf.add('ADV', 'Watch started: ' + watchCount + ' device(s)', null);
  updateConnectionStatus('connected');

  // Disconnect GATT connections to save sensor battery (after watches are set up)
  Object.values(sensors).forEach(function(s) {
    if (s.server) {
      try { s.server.disconnect(); } catch (e) {}
      blePerf.add('ADV', 'Disconnected GATT for ' + (settings.names[s.id] || s.name) + ' (battery save)', null);
    }
  });
}

function stopAdvertScan() {
  // Remove listeners from all watched devices
  advWatchedDevices.forEach(function(w) {
    try { w.device.removeEventListener('advertisementreceived', onAdvertReceived); } catch (e) {}
  });
  advWatchedDevices = [];

  // Also remove global listener + abort controller (for requestLEScan fallback)
  try { navigator.bluetooth.removeEventListener('advertisementreceived', onAdvertReceived); } catch (e) {}
  if (advScanAbort) {
    try { advScanAbort.abort(); } catch (e) {}
    advScanAbort = null;
  }

  advScanActive = false;
  blePerf.add('ADV', 'Watch stopped', null);
}

function onAdvertReceived(event) {
  var device = event.device;
  var name = event.name || device.name || '';
  var id = device.id;

  // Only process ATC_ named devices or known devices
  if (!name.startsWith('ATC_') && !knownDevices[id]) return;

  blePerf.trackNotification(id);

  // serviceData is a Map: key = UUID string, value = DataView
  // Iterate the Map like the Chrome sample: .forEach((valueDataView, key) => ...)
  var serviceData = event.serviceData;
  var parsed = false;

  if (serviceData && serviceData.size > 0) {
    serviceData.forEach(function(dataView, uuid) {
      if (parsed) return; // already matched
      var uuidStr = String(uuid).toLowerCase();
      var len = dataView.byteLength;

      // Match by UUID — keys come as full 128-bit UUID strings
      // 0x181A → '0000181a-0000-1000-8000-00805f9b34fb' (Environmental Sensing)
      if (uuidStr.indexOf('181a') === 4 || uuidStr === '181a' || uuid === 0x181A) {
        if (len >= 13) {
          parseAdvPVVX(id, name, dataView);
          parsed = true;
        } else if (len >= 10) {
          parseAdvATC1441(id, name, dataView);
          parsed = true;
        }
      }
      // 0xFCD2 → BTHome v2
      else if (uuidStr.indexOf('fcd2') === 4 || uuidStr === 'fcd2' || uuid === 0xFCD2) {
        if (len >= 3) {
          parseAdvBTHome(id, name, dataView);
          parsed = true;
        }
      }
      // 0xFE95 → Xiaomi Mi
      else if (uuidStr.indexOf('fe95') === 4 || uuidStr === 'fe95' || uuid === 0xFE95) {
        if (len >= 5) {
          parseAdvMiLike(id, name, dataView);
          parsed = true;
        }
      }
    });
  }

  // Also log RSSI and txPower if available
  if (parsed && (event.rssi !== undefined || event.txPower !== undefined)) {
    var s = sensors[id];
    if (s) {
      s.rssi = event.rssi;
      s.txPower = event.txPower;
    }
  }

  // Even if we couldn't parse service data, register the device if it has a name
  if (!parsed && name.startsWith('ATC_')) {
    ensureAdvSensor(id, name);
    // Log raw advert data for debugging
    var rawKeys = [];
    if (serviceData) serviceData.forEach(function(dv, key) { rawKeys.push(key + '(' + dv.byteLength + 'B)'); });
    blePerf.add('ADV', 'Advert from ' + name + ' (unparsed: ' + (rawKeys.length ? rawKeys.join(', ') : 'no service data') + ')', null);
  }
}

function ensureAdvSensor(id, name) {
  if (!sensors[id]) {
    sensors[id] = {
      device: { id: id, name: name },
      server: null, id: id,
      name: settings.names[id] || name || 'Sensor',
      customChar: null, otaChar: null, miTempChar: null,
      temp: null, humi: null, batt: null, vbat: null,
      count: 0, lastUpdate: null, chart: null,
      hwVer: null, swVer: null, hwName: null, cfg: null,
      advMode: true  // flag: data comes from advertisements
    };
  }
  saveKnownDevice(id, name);
}

/* Parse PVVX Custom advertisement (UUID 0x181A, 13+ bytes)
   [0-5] MAC, [6-7] temp(int16)/100, [8-9] humi(uint16)/100,
   [10-11] vbat(uint16) mV, [12] batt% */
function parseAdvPVVX(id, name, dv) {
  ensureAdvSensor(id, name);
  var s = sensors[id];
  var temp = roundTemp(dv.getInt16(6, true) / 100.0);
  var humi = roundHumi(dv.getUint16(8, true) / 100.0);
  var vbat = dv.getUint16(10, true);
  var batt = dv.getUint8(12);

  s.temp = temp; s.humi = humi; s.vbat = vbat; s.batt = batt;
  s.lastUpdate = new Date();
  if (dv.byteLength >= 14) s.count = dv.getUint8(13);

  var rate = blePerf.getSensorRate(id);
  blePerf.add('ADV', 'PVVX ' + (settings.names[id] || name), null, {
    temp: temp.toFixed(1), humi: humi.toFixed(1), batt: batt + '%',
    interval: rate ? rate.avgMs + 'ms' : 'first'
  });

  storeReading(id, temp, humi, batt);
  checkAlerts(id, humi);
  checkBatteryAlerts(id, batt);
  renderDashboard();
}

/* Parse ATC1441 advertisement (UUID 0x181A, 10-12 bytes)
   [0-5] MAC, [6] temp_hi, [7] temp_lo, [8] humi%, [9] batt% */
function parseAdvATC1441(id, name, dv) {
  ensureAdvSensor(id, name);
  var s = sensors[id];
  var temp = roundTemp(dv.getInt16(6, true) / 10.0);
  var humi = dv.getUint8(8);
  var batt = dv.getUint8(9);

  s.temp = temp; s.humi = humi; s.batt = batt;
  s.lastUpdate = new Date();

  blePerf.add('ADV', 'ATC1441 ' + (settings.names[id] || name), null, {
    temp: temp.toFixed(1), humi: humi, batt: batt + '%'
  });

  storeReading(id, temp, humi, batt);
  checkAlerts(id, humi);
  checkBatteryAlerts(id, batt);
  renderDashboard();
}

/* Parse BTHome v2 advertisement (UUID 0xFCD2)
   TLV format: [objectId][value...] */
function parseAdvBTHome(id, name, dv) {
  ensureAdvSensor(id, name);
  var s = sensors[id];
  var offset = 0;
  // First byte may be device info (BTHome v2)
  var devInfo = dv.getUint8(0);
  if ((devInfo & 0x20) !== 0) offset = 1; // v2 has device info byte

  var temp = null, humi = null, batt = null, vbat = null;
  while (offset < dv.byteLength - 1) {
    var objId = dv.getUint8(offset); offset++;
    switch (objId) {
      case 0x01: // battery %
        if (offset < dv.byteLength) { batt = dv.getUint8(offset); offset += 1; }
        break;
      case 0x02: // temperature sint16 / 100
        if (offset + 1 < dv.byteLength) { temp = dv.getInt16(offset, true) / 100.0; offset += 2; }
        break;
      case 0x03: // humidity uint16 / 100
        if (offset + 1 < dv.byteLength) { humi = dv.getUint16(offset, true) / 100.0; offset += 2; }
        break;
      case 0x0C: // voltage uint16 mV
        if (offset + 1 < dv.byteLength) { vbat = dv.getUint16(offset, true); offset += 2; }
        break;
      default:
        // Skip unknown: try to advance (BTHome objects are 1-4 bytes value)
        offset += 1; // best guess
        break;
    }
  }

  if (temp !== null) s.temp = roundTemp(temp);
  if (humi !== null) s.humi = roundHumi(humi);
  if (batt !== null) s.batt = batt;
  if (vbat !== null) s.vbat = vbat;
  if (temp !== null || humi !== null) s.lastUpdate = new Date();

  blePerf.add('ADV', 'BTHome ' + (settings.names[id] || name), null, {
    temp: s.temp !== null ? s.temp.toFixed(1) : '?',
    humi: s.humi !== null ? s.humi.toFixed(1) : '?',
    batt: s.batt !== null ? s.batt + '%' : '?'
  });

  if (s.temp !== null && s.humi !== null) {
    storeReading(id, s.temp, s.humi, s.batt);
    checkAlerts(id, s.humi);
    if (s.batt !== null) checkBatteryAlerts(id, s.batt);
  }
  renderDashboard();
}

/* Parse Mi-Like advertisement (UUID 0xFE95) — basic extraction */
function parseAdvMiLike(id, name, dv) {
  ensureAdvSensor(id, name);
  var s = sensors[id];
  // Mi advert format varies, look for data type tags in payload
  // Skip frame header (variable length), look for known data types
  var offset = 0;
  var temp = null, humi = null, batt = null;

  while (offset < dv.byteLength - 3) {
    var dtype = dv.getUint16(offset, true); offset += 2;
    var dlen = dv.getUint8(offset); offset++;
    if (offset + dlen > dv.byteLength) break;

    if (dtype === 0x1004 && dlen >= 2) { // temperature
      temp = dv.getInt16(offset, true) / 10.0;
    } else if (dtype === 0x1006 && dlen >= 2) { // humidity
      humi = dv.getUint16(offset, true) / 10.0;
    } else if (dtype === 0x100A && dlen >= 1) { // battery
      batt = dv.getUint8(offset);
    } else if (dtype === 0x100D && dlen >= 4) { // temp + humi combo
      temp = dv.getInt16(offset, true) / 10.0;
      humi = dv.getUint16(offset + 2, true) / 10.0;
    }
    offset += dlen;
  }

  if (temp !== null) s.temp = roundTemp(temp);
  if (humi !== null) s.humi = roundHumi(humi);
  if (batt !== null) s.batt = batt;
  if (temp !== null || humi !== null) s.lastUpdate = new Date();

  blePerf.add('ADV', 'Mi-Like ' + (settings.names[id] || name), null, {
    temp: s.temp !== null ? s.temp.toFixed(1) : '?',
    humi: s.humi !== null ? s.humi.toFixed(1) : '?'
  });

  if (s.temp !== null && s.humi !== null) {
    storeReading(id, s.temp, s.humi, s.batt);
    checkAlerts(id, s.humi);
    if (s.batt !== null) checkBatteryAlerts(id, s.batt);
  }
  renderDashboard();
}

/* ── Alerts ── */
function checkAlerts(sensorId, humi) {
  var s = sensors[sensorId];
  if (!s) return;
  var now = Date.now();
  var cooldown = 1800000;
  if (humi >= settings.crit) {
    if (!alertCooldowns[sensorId] || now - alertCooldowns[sensorId] > cooldown) {
      alertCooldowns[sensorId] = now;
      var name = settings.names[sensorId] || s.name;
      showAlert('CRITICAL: ' + name + ' humidity at ' + humi.toFixed(1) + '%', 'critical');
      sendNotification(name + ': Humidity Critical!', 'Humidity is ' + humi.toFixed(1) + '% — above ' + settings.crit + '% threshold.');
    }
  } else if (humi >= settings.warn) {
    if (!alertCooldowns[sensorId] || now - alertCooldowns[sensorId] > cooldown) {
      alertCooldowns[sensorId] = now;
      showAlert('WARNING: ' + (settings.names[sensorId] || s.name) + ' humidity at ' + humi.toFixed(1) + '%', 'warn');
    }
  }
}

/* ── Battery Level Warnings ── */
function checkBatteryAlerts(sensorId, battPct) {
  var s = sensors[sensorId];
  if (!s || battPct === null || battPct === undefined) return;
  var name = settings.names[sensorId] || s.name;
  var now = Date.now();
  var cooldown = 3600000; // 1 hour cooldown between repeated battery alerts

  // Critical: at or below 10% — immediate alert
  if (battPct <= 10) {
    // Still count for the low-battery counter
    battLowCount[sensorId] = (battLowCount[sensorId] || 0) + 1;
    if (!battAlertCooldowns[sensorId] || now - battAlertCooldowns[sensorId] > cooldown) {
      battAlertCooldowns[sensorId] = now;
      showAlert('CRITICAL BATTERY: ' + name + ' at ' + battPct + '% — Replace battery as soon as possible!', 'critical');
      sendNotification(name + ': Battery Critical!', 'Battery at ' + battPct + '%. Replace battery as soon as possible!');
      blePerf.add('BATT', 'CRITICAL: ' + name + ' at ' + battPct + '%', null);
    }
    return;
  }

  // Low: below 20% — alert after 5 consecutive frames
  if (battPct < 20) {
    battLowCount[sensorId] = (battLowCount[sensorId] || 0) + 1;
    if (battLowCount[sensorId] >= 5) {
      if (!battAlertCooldowns[sensorId] || now - battAlertCooldowns[sensorId] > cooldown) {
        battAlertCooldowns[sensorId] = now;
        showAlert('LOW BATTERY: ' + name + ' at ' + battPct + '% (5 consecutive low readings)', 'warn');
        sendNotification(name + ': Low Battery', 'Battery at ' + battPct + '% for 5 consecutive readings.');
        blePerf.add('BATT', 'LOW: ' + name + ' at ' + battPct + '% (5 frames)', null);
      }
    }
  } else {
    // Battery is above 20% — reset the consecutive counter
    battLowCount[sensorId] = 0;
  }
}

function showAlert(msg, type) {
  var banner = document.getElementById('alertBanner');
  banner.textContent = msg;
  banner.className = 'border-b px-5 py-3 text-center font-mono font-bold text-sm';
  if (type === 'error' || type === 'critical') {
    banner.className += ' bg-red-500/20 border-red-500/50 text-red-400';
  } else if (type === 'warn') {
    banner.className += ' bg-yellow-500/20 border-yellow-500/50 text-yellow-400';
  } else if (type === 'success') {
    banner.className += ' bg-green-500/20 border-green-500/50 text-green-400';
  } else {
    banner.className += ' bg-zinc-700/40 border-zinc-600/50 text-zinc-300';
  }
  setTimeout(function() { banner.classList.add('hidden'); }, type === 'critical' ? 15000 : 6000);

  // Push to alert history
  alertHistory.unshift({ msg: msg, type: type || 'info', time: new Date() });
  if (alertHistory.length > 200) alertHistory.length = 200;
  alertUnread++;
  updateAlertBadge();
}

function updateAlertBadge() {
  var badge = document.getElementById('alertBadge');
  if (!badge) return;
  if (alertUnread > 0) {
    badge.textContent = alertUnread > 99 ? '99' : alertUnread;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

function openAlertHistory() {
  alertUnread = 0;
  updateAlertBadge();
  renderAlertHistory();
  document.getElementById('alertHistoryModal').classList.remove('hidden');
  if (window.lucide) lucide.createIcons();
}

function closeAlertHistory() {
  document.getElementById('alertHistoryModal').classList.add('hidden');
}

function clearAlertHistory() {
  alertHistory = [];
  alertUnread = 0;
  updateAlertBadge();
  renderAlertHistory();
}

function renderAlertHistory() {
  var list = document.getElementById('alertHistoryList');
  var countEl = document.getElementById('alertHistoryCount');
  if (!list) return;
  if (countEl) countEl.textContent = alertHistory.length + ' alert' + (alertHistory.length !== 1 ? 's' : '');
  if (alertHistory.length === 0) {
    list.innerHTML = '<div class="text-zinc-600 font-mono text-xs py-8 text-center">No alerts yet.</div>';
    return;
  }
  list.innerHTML = alertHistory.map(function(a) {
    var colors = { critical: 'text-red-400 bg-red-500/10 border-red-500/20', error: 'text-red-400 bg-red-500/10 border-red-500/20', warn: 'text-yellow-400 bg-yellow-500/10 border-yellow-500/20', success: 'text-green-400 bg-green-500/10 border-green-500/20', info: 'text-zinc-300 bg-zinc-800/50 border-zinc-700/50' };
    var dot = { critical: 'bg-red-400', error: 'bg-red-400', warn: 'bg-yellow-400', success: 'bg-green-400', info: 'bg-zinc-500' };
    var cls = colors[a.type] || colors.info;
    var dotCls = dot[a.type] || dot.info;
    var t = a.time;
    var ts = String(t.getHours()).padStart(2, '0') + ':' + String(t.getMinutes()).padStart(2, '0') + ':' + String(t.getSeconds()).padStart(2, '0');
    return '<div class="flex items-start gap-2.5 px-3 py-2 rounded-lg border ' + cls + '">' +
      '<div class="w-2 h-2 rounded-full mt-1 shrink-0 ' + dotCls + '"></div>' +
      '<div class="flex-1 min-w-0">' +
        '<div class="font-mono text-xs leading-relaxed break-words">' + esc(a.msg) + '</div>' +
      '</div>' +
      '<div class="text-[10px] text-zinc-600 font-mono shrink-0 mt-0.5">' + ts + '</div>' +
    '</div>';
  }).join('');
}

function sendNotification(title, body) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, { body: body, icon: 'icons/icon-192.svg' });
  }
}

/* ── UI Rendering ── */
function updateConnectionStatus(status) {
  var dot = document.getElementById('statusDot');
  dot.className = 'w-2.5 h-2.5 rounded-full ring-2 ';
  if (status === 'connected') dot.className += 'bg-green-400 ring-green-400/30';
  else if (status === 'connecting') dot.className += 'bg-yellow-400 ring-yellow-400/30 animate-pulse';
  else dot.className += 'bg-red-500 ring-red-500/30';
}

function renderDashboard() {
  var grid = document.getElementById('sensorGrid');
  var panel = document.getElementById('connectPanel');

  // Merge connected sensors + known (saved) devices not yet connected
  var activeIds = Object.keys(sensors);
  var savedIds = Object.keys(knownDevices).filter(function(kid) { return activeIds.indexOf(kid) === -1; });
  var allIds = activeIds.concat(savedIds);

  if (allIds.length === 0) {
    grid.innerHTML = '';
    panel.classList.remove('hidden');
    return;
  }
  panel.classList.add('hidden');

  grid.innerHTML = allIds.map(function(id) {
    var s = sensors[id];
    var isSavedOnly = !s;
    var connected = s ? !!s.server : false;
    var name = settings.names[id] || (s ? s.name : null) || (knownDevices[id] ? knownDevices[id].deviceName : id);
    // Saved-only (not currently connected) card
    if (isSavedOnly) {
      var devName = knownDevices[id] ? knownDevices[id].deviceName : id;
      return '<div class="group bg-zinc-900 border border-zinc-800 rounded-lg p-5 opacity-60 hover:opacity-100 transition-all duration-300">' +
        '<div class="flex justify-between items-start mb-4">' +
          '<div>' +
            '<div class="font-mono font-bold text-zinc-400 cursor-pointer hover:text-amber-400 transition-colors" ondblclick="editFriendlyName(this,\'' + id + '\')" title="Double-click to rename">' + esc(name) + '</div>' +
            '<div class="text-xs text-zinc-600 font-mono mt-0.5">' + esc(devName) + '</div>' +
          '</div>' +
          '<span class="text-xs px-2 py-0.5 bg-zinc-800 text-zinc-500 rounded font-mono">SAVED</span>' +
        '</div>' +
        '<div class="grid grid-cols-2 gap-3 mb-4">' +
          '<div class="bg-zinc-800/50 rounded-lg p-3 text-center">' +
            '<div class="font-mono font-bold text-2xl text-zinc-600">—</div>' +
            '<div class="text-xs text-zinc-600 font-mono mt-1">TEMP °C</div>' +
          '</div>' +
          '<div class="bg-zinc-800/50 rounded-lg p-3 text-center">' +
            '<div class="font-mono font-bold text-2xl text-zinc-600">—</div>' +
            '<div class="text-xs text-zinc-600 font-mono mt-1">HUMIDITY</div>' +
          '</div>' +
        '</div>' +
        '<div class="flex justify-center gap-2">' +
          '<button onclick="reconnectByName(\'' + esc(devName) + '\')" class="bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors inline-flex items-center gap-1.5"><i data-lucide="bluetooth" class="w-3.5 h-3.5"></i> Reconnect</button>' +
          '<button onclick="showForgetConfirm(\'' + id + '\')" class="bg-zinc-800 hover:bg-red-500/20 text-zinc-500 hover:text-red-400 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors inline-flex items-center gap-1.5 border border-zinc-700 hover:border-red-500/30"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Forget</button>' +
        '</div>' +
      '</div>';
    }

    var ago = s.lastUpdate ? timeAgo(s.lastUpdate) : 'never';
    var borderClass = '';
    if (s.humi !== null && s.humi >= settings.crit) borderClass = 'border-red-500/50';
    else if (s.humi !== null && s.humi >= settings.warn) borderClass = 'border-yellow-500/50';
    else borderClass = 'border-zinc-700';

    var humiColor = 'text-amber-500';
    if (s.humi !== null && s.humi >= settings.crit) humiColor = 'text-red-400';
    else if (s.humi !== null && s.humi >= settings.warn) humiColor = 'text-yellow-400';

    var battPct = s.batt || 0;
    var battColor = battPct > 50 ? 'bg-green-400' : battPct > 20 ? 'bg-yellow-400' : 'bg-red-400';

    return '<div class="group bg-zinc-900 border ' + borderClass + ' rounded-lg p-5 hover:border-amber-500/50 hover:shadow-lg hover:shadow-amber-500/10 hover:-translate-y-1 transition-all duration-300">' +
      '<div class="flex justify-between items-start mb-4">' +
        '<div>' +
          '<div class="font-mono font-bold text-zinc-100 cursor-pointer hover:text-amber-400 transition-colors" ondblclick="editFriendlyName(this,\'' + id + '\')" title="Double-click to rename">' + esc(name) + '</div>' +
          '<div class="text-xs text-zinc-500 font-mono mt-0.5">' + esc(s.device ? s.device.name || id : id) + (s.hwName ? ' &middot; ' + esc(s.hwName) : '') + '</div>' +
        '</div>' +
        (connected
          ? '<span class="text-xs px-2 py-0.5 bg-green-400/10 text-green-400 rounded font-mono">LIVE</span>'
          : '<button onclick="reconnectByName(\'' + esc(s.device ? s.device.name || '' : '') + '\')" class="bg-zinc-700 hover:bg-zinc-600 text-zinc-300 text-xs font-mono px-3 py-1.5 rounded-lg transition-colors">Reconnect</button>') +
      '</div>' +
      '<div class="grid grid-cols-2 gap-3 mb-4">' +
        '<div class="bg-zinc-800 rounded-lg p-3 text-center">' +
          '<div class="font-mono font-bold text-2xl text-amber-500">' + (s.temp !== null ? s.temp.toFixed(1) + '°' : '—') + '</div>' +
          '<div class="text-xs text-zinc-500 font-mono mt-1">TEMP °C</div>' +
        '</div>' +
        '<div class="bg-zinc-800 rounded-lg p-3 text-center">' +
          '<div class="font-mono font-bold text-2xl ' + humiColor + '">' + (s.humi !== null ? s.humi.toFixed(1) + '%' : '—') + '</div>' +
          '<div class="text-xs text-zinc-500 font-mono mt-1">HUMIDITY</div>' +
        '</div>' +
      '</div>' +
      '<div class="flex items-center justify-between text-xs text-zinc-500 font-mono">' +
        '<div class="flex items-center gap-2">' +
          '<div class="flex items-center gap-1.5">' +
            '<div class="w-8 h-2.5 bg-zinc-800 rounded-full overflow-hidden border border-zinc-700">' +
              '<div class="h-full ' + battColor + ' rounded-full" style="width:' + battPct + '%"></div>' +
            '</div>' +
            '<span>' + (s.batt !== null ? s.batt + '%' : '?') + '</span>' +
          '</div>' +
          (s.vbat ? '<span class="text-zinc-600">' + (s.vbat / 1000).toFixed(2) + 'V</span>' : '') +
        '</div>' +
        '<span>' + ago + '</span>' +
      '</div>' +
    '</div>';
  }).join('');

  lucide.createIcons();
}

function renderCharts() {
  var container = document.getElementById('chartsContainer');
  var noMsg = document.getElementById('noChartsMsg');
  var ids = Object.keys(sensors);

  if (ids.length === 0) {
    container.innerHTML = '';
    noMsg.classList.remove('hidden');
    return;
  }
  noMsg.classList.add('hidden');

  ids.forEach(function(id) {
    var s = sensors[id];
    var name = settings.names[id] || s.name;
    var chartDiv = document.getElementById('chart-' + id);
    if (!chartDiv) {
      chartDiv = document.createElement('div');
      chartDiv.id = 'chart-' + id;
      chartDiv.className = 'bg-zinc-900 border border-zinc-700 rounded-lg p-5 mb-4';
      chartDiv.innerHTML = '<h3 class="font-mono text-sm text-zinc-400 mb-3">' + esc(name) + '</h3><div class="chart-wrap"><canvas id="canvas-' + id + '"></canvas></div>';
      container.appendChild(chartDiv);
    } else {
      chartDiv.querySelector('h3').textContent = name;
    }

    getHistory(id, 24).then(function(history) {
      if (history.length === 0) return;
      var tempData = history.map(function(h) { return { x: h.time, y: Math.round(h.temp * 5) / 5 }; });
      var humiData = history.map(function(h) { return { x: h.time, y: h.humi }; });

      if (s.chart) {
        s.chart.data.datasets[0].data = tempData;
        s.chart.data.datasets[1].data = humiData;
        s.chart.update('none');
      } else {
        var ctx = document.getElementById('canvas-' + id);
        if (!ctx) return;
        s.chart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [
              { label: 'Temp °C', data: tempData, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.08)', yAxisID: 'yTemp', tension: 0.3, pointRadius: 0, borderWidth: 2, fill: true },
              { label: 'Humidity %', data: humiData, borderColor: '#a1a1aa', backgroundColor: 'rgba(161,161,170,0.06)', yAxisID: 'yHumi', tension: 0.3, pointRadius: 0, borderWidth: 2, fill: true }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { labels: { color: '#71717a', font: { family: 'JetBrains Mono', size: 11 }, boxWidth: 10, padding: 16 } } },
            scales: {
              x: { type: 'time', time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } }, grid: { color: 'rgba(63,63,70,0.4)' }, ticks: { color: '#71717a', font: { family: 'JetBrains Mono', size: 10 }, maxTicksLimit: 12 } },
              yTemp: { position: 'left', grid: { color: 'rgba(63,63,70,0.2)' }, ticks: { color: '#f59e0b', font: { family: 'JetBrains Mono', size: 10 } }, title: { display: true, text: '°C', color: '#f59e0b', font: { family: 'JetBrains Mono' } } },
              yHumi: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#a1a1aa', font: { family: 'JetBrains Mono', size: 10 } }, title: { display: true, text: '%', color: '#a1a1aa', font: { family: 'JetBrains Mono' } }, min: 0, max: 100 }
            }
          }
        });
      }
    });
  });
}

function updateOTADeviceList() {
  var select = document.getElementById('otaDeviceSelect');
  var ids = Object.keys(sensors).filter(function(id) { return !!sensors[id].server; });
  if (ids.length === 0) {
    select.innerHTML = '<option value="">— connect a sensor first —</option>';
  } else {
    select.innerHTML = ids.map(function(id) {
      var s = sensors[id];
      var name = settings.names[id] || s.name;
      var hasOta = s.otaChar ? '' : ' (no OTA)';
      return '<option value="' + id + '">' + esc(name) + hasOta + '</option>';
    }).join('');
  }
}

function updateSensorNamesList() {
  var list = document.getElementById('sensorNamesList');
  // Show all known devices (connected + saved)
  var activeIds = Object.keys(sensors);
  var savedIds = Object.keys(knownDevices).filter(function(kid) { return activeIds.indexOf(kid) === -1; });
  var allIds = activeIds.concat(savedIds);
  if (allIds.length === 0) {
    list.innerHTML = '<p class="text-zinc-500 text-xs font-mono">Connect sensors to assign friendly names.</p>';
    return;
  }
  list.innerHTML = allIds.map(function(id) {
    var s = sensors[id];
    var devLabel = s ? (s.device ? s.device.name || id : id) : (knownDevices[id] ? knownDevices[id].deviceName : id);
    var name = settings.names[id] || (s ? s.name : '') || '';
    return '<div class="flex gap-3 items-center py-2">' +
      '<span class="text-xs text-zinc-500 font-mono w-36 shrink-0 truncate">' + esc(devLabel) + '</span>' +
      '<input type="text" value="' + esc(name) + '" placeholder="Friendly name" onchange="setSensorName(\'' + id + '\', this.value)" class="flex-1 bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 font-mono text-sm text-zinc-100 focus:border-amber-500 focus:outline-none">' +
    '</div>';
  }).join('');
}

function setSensorName(id, name) {
  settings.names[id] = name;
  if (sensors[id]) sensors[id].name = name;
  saveSettings();
  renderDashboard();
  updateOTADeviceList();
}

function editFriendlyName(el, id) {
  if (el.querySelector('input')) return; // already editing
  var current = settings.names[id] || '';
  var bleName = (sensors[id] ? sensors[id].device ? sensors[id].device.name : '' : '') || (knownDevices[id] ? knownDevices[id].deviceName : '') || id;
  var input = document.createElement('input');
  input.type = 'text';
  input.value = current;
  input.placeholder = bleName;
  input.className = 'bg-zinc-800 border border-amber-500 rounded px-2 py-0.5 font-mono font-bold text-zinc-100 text-sm w-full focus:outline-none';
  input.style.minWidth = '0';
  function commit() {
    var val = input.value.trim();
    setSensorName(id, val || bleName);
  }
  input.addEventListener('blur', commit);
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { e.preventDefault(); input.value = current; input.blur(); }
  });
  el.textContent = '';
  el.appendChild(input);
  input.focus();
  input.select();
}

/* ── Battery Profile UI & Firmware Write ── */
function renderBatteryProfiles() {
  var sel = document.getElementById('batteryProfileSelect');
  if (!sel) return;
  var current = settings.batteryProfile || DEFAULT_BATTERY_PROFILE;
  var html = '';
  Object.keys(BATTERY_PROFILES).forEach(function(key) {
    var p = BATTERY_PROFILES[key];
    html += '<option value="' + key + '"' + (key === current ? ' selected' : '') + '>' +
      p.label + ' — ' + p.desc + '</option>';
  });
  sel.innerHTML = html;
}

function selectBatteryProfile(key) {
  if (!BATTERY_PROFILES[key]) return;
  settings.batteryProfile = key;
  sensorLastPolled = {}; // reset throttle timers
  saveSettings();
  renderBatteryProfiles();
  blePerf.add('PROFILE', 'Battery profile → ' + BATTERY_PROFILES[key].label, null);
  // Push firmware config to all connected sensors
  writeBatteryProfileToSensors(key);
}

async function writeBatteryProfileToSensors(key) {
  var p = BATTERY_PROFILES[key];
  if (!p) return;
  var status = document.getElementById('batteryProfileStatus');
  var written = 0;
  var sensorList = Object.values(sensors).filter(function(s) { return s.customChar; });

  if (sensorList.length === 0) {
    if (status) {
      status.textContent = 'Profile saved. Connect sensors to apply.';
      status.classList.remove('hidden');
    }
    return;
  }

  for (var i = 0; i < sensorList.length; i++) {
    var s = sensorList[i];
    try {
      // Read current config first (cmd 0x55)
      await s.customChar.writeValue(new Uint8Array([0x55]));
      await new Promise(function(r) { setTimeout(r, 300); });

      // Build config write command — preserve existing config, only change profile fields
      // We need to read from parseFlasherConfig response, but for dashboard sensors
      // we write a minimal config update: measure_interval, adv_interval, tx_power
      var cmd = new Uint8Array(14);
      cmd[0] = 0x55;
      // Byte 1: advType|flags — preserve current (default to custom=1, lp_measures=1)
      cmd[1] = 0x41; // custom adv type + lp_measures flag
      var dv = new DataView(cmd.buffer);
      dv.setInt16(2, 0, true);  // temp offset — preserve 0
      dv.setInt16(4, 0, true);  // humi offset — preserve 0
      dv.setUint16(6, Math.round(p.advInterval / 0.625), true); // adv interval in 0.625ms units
      cmd[8] = Math.min(255, p.measInterval);  // measure interval (uint8, max 255)
      cmd[9] = p.txPower;  // TX power register
      dv.setUint16(10, 0, true); // connect latency
      cmd[12] = 0; // LCD cfg (temp_C)
      cmd[13] = 0; // BT5 PHY off

      await s.customChar.writeValue(cmd);
      written++;
      var label = settings.names[s.id] || s.name || s.id.substr(0, 8);
      blePerf.add('PROFILE', 'Config written to ' + label + ': meas=' + p.measInterval + 's, adv=' + p.advInterval + 'ms, tx=' + p.txPower, null);
    } catch (e) {
      blePerf.add('PROFILE', 'Failed to write config to ' + (s.id.substr(0, 8)) + ': ' + e.message, null);
    }
  }

  if (status) {
    status.textContent = 'Profile applied to ' + written + '/' + sensorList.length + ' sensor(s)';
    status.className = 'mt-3 text-xs font-mono ' + (written > 0 ? 'text-green-400' : 'text-red-400');
  }
}

/* ═══════════════════════════════════════════════
   Flasher — Advanced Telink Mi Flasher
   ═══════════════════════════════════════════════ */

var flasherMode = 'simple';
var flDevice = null;        // BLE device for flasher
var flServer = null;        // GATT server
var flCustomChar = null;    // 0x1F1F char for config r/w
var flOtaChar = null;       // OTA char
var flConfig = null;        // parsed config object
var flFirmwareData = null;  // ArrayBuffer for advanced OTA
var flFirmwareInfo = null;
var flRemoteFirmwares = []; // from GitHub firmware.json
var flLog = [];

var FL_HW_VERSIONS = [
  'LYWSD03MMC B1.4','MHO-C401 (old)','CGG1-M 2020/21','LYWSD03MMC B1.6','LYWSD03MMC B1.7',
  'LYWSD03MMC B1.9','CGDK2','CGG1-M 2022','MHO-C401 2022','MJWSD05MMC (ch)',
  'LYWSD03MMC B2.0','MHO-C122','MJWSD05MMC (en)','Unknown 13','Unknown 14',
  'Unknown 15','Unknown 16','TS0201_TZ3000','TH03Z','ZTH01/ZTH02',
  'TNK01','TH-05Z','Unknown 22','Unknown 23','Unknown 24',
  'LYWSD03MMC B1.4 (Zigbee)','MHO-C401 Zigbee','CGG1-M Zigbee','LYWSD03MMC B1.6 Zigbee','LYWSD03MMC B1.7 Zigbee',
  'LYWSD03MMC B1.9 Zigbee','CGDK2 Zigbee','CGG1-M 2022 Zigbee','MHO-C401 2022 Zigbee','MJWSD05MMC Zigbee',
  'LYWSD03MMC B2.0 Zigbee','MHO-C122 Zigbee','MJWSD05MMC Zigbee','Unknown 38','Unknown 39',
  'Unknown 40','Unknown 41','Unknown 42','Unknown 43','Unknown 44',
  'Unknown 45','Unknown 46','Unknown 47'
];

var FL_TX_POWERS = [
  { value: 0, label: '-25.3 dBm', reg: 0x00 },
  { value: 1, label: '-17.1 dBm', reg: 0x01 },
  { value: 2, label: '-12.2 dBm', reg: 0x02 },
  { value: 3, label: '-8.7 dBm', reg: 0x03 },
  { value: 4, label: '-5.8 dBm', reg: 0x04 },
  { value: 5, label: '-3.5 dBm', reg: 0x05 },
  { value: 6, label: '-1.6 dBm', reg: 0x06 },
  { value: 7, label: '0 dBm', reg: 0x07 },
  { value: 8, label: '1.0 dBm', reg: 0x08 },
  { value: 9, label: '1.6 dBm', reg: 0x09 },
  { value: 10, label: '3.0 dBm', reg: 0x0a }
];

function setFlasherMode(mode) {
  flasherMode = mode;
  var simplePanel = document.getElementById('flasherSimple');
  var advPanel = document.getElementById('flasherAdvanced');
  var btnSimple = document.getElementById('flasherModeSimple');
  var btnAdvanced = document.getElementById('flasherModeAdvanced');
  if (mode === 'simple') {
    simplePanel.classList.remove('hidden');
    advPanel.classList.add('hidden');
    btnSimple.className = 'px-5 py-2 rounded-lg font-mono text-xs font-bold transition-colors bg-amber-500 text-zinc-900';
    btnAdvanced.className = 'px-5 py-2 rounded-lg font-mono text-xs font-bold transition-colors text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800';
  } else {
    simplePanel.classList.add('hidden');
    advPanel.classList.remove('hidden');
    btnSimple.className = 'px-5 py-2 rounded-lg font-mono text-xs font-bold transition-colors text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800';
    btnAdvanced.className = 'px-5 py-2 rounded-lg font-mono text-xs font-bold transition-colors bg-amber-500 text-zinc-900';
  }
  lucide.createIcons();
}

function flLogMsg(msg, type) {
  var ts = new Date().toISOString().substr(11, 12);
  var colorCls = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : type === 'warn' ? 'text-yellow-400' : type === 'info' ? 'text-amber-400' : 'text-zinc-400';
  flLog.push({ ts: ts, msg: msg, type: type || '' });
  var el = document.getElementById('flasherLog');
  if (!el) return;
  var div = document.createElement('div');
  div.className = colorCls;
  div.textContent = '[' + ts + '] ' + msg;
  el.appendChild(div);
  el.scrollTop = el.scrollHeight;
}

function clearFlasherLog() {
  flLog = [];
  var el = document.getElementById('flasherLog');
  if (el) el.innerHTML = '<div class="text-zinc-600">Log cleared.</div>';
}

function flUpdateConnUI(connected) {
  var statusEl = document.getElementById('flConnStatus');
  var btnConn = document.getElementById('btnFlConnect');
  var btnDisc = document.getElementById('btnFlDisconnect');
  if (connected) {
    statusEl.textContent = 'Connected';
    statusEl.className = 'text-xs font-mono px-2 py-0.5 rounded bg-green-400/10 text-green-400';
    btnConn.classList.add('hidden');
    btnDisc.classList.remove('hidden');
  } else {
    statusEl.textContent = 'Disconnected';
    statusEl.className = 'text-xs font-mono px-2 py-0.5 rounded bg-zinc-800 text-zinc-500';
    btnConn.classList.remove('hidden');
    btnDisc.classList.add('hidden');
    // Hide config sections
    ['flConfigSection','flComfortSection','flTriggerSection','flMiAuthSection','flDevMgmtSection','flOtaSection','flDeviceInfo'].forEach(function(id) {
      document.getElementById(id).classList.add('hidden');
    });
  }
  lucide.createIcons();
}

async function flasherConnect() {
  if (!navigator.bluetooth) {
    flLogMsg('Web Bluetooth not supported', 'error');
    return;
  }
  var prefix = document.getElementById('flNamePrefix').value.trim();
  var filters = prefix ? [{ namePrefix: prefix }] : [{ services: [UUID_CUSTOM_SVC] }];
  try {
    flLogMsg('Requesting device' + (prefix ? ' with prefix "' + prefix + '"' : '') + '...');
    flDevice = await navigator.bluetooth.requestDevice({
      filters: filters,
      optionalServices: BLE_OPTIONAL_SVCS
    });
    flDevice.addEventListener('gattserverdisconnected', function() {
      flLogMsg('Device disconnected', 'warn');
      flServer = null; flCustomChar = null; flOtaChar = null; flConfig = null;
      flUpdateConnUI(false);
    });
    flLogMsg('Connecting to GATT server...');
    flServer = await flDevice.gatt.connect();
    flLogMsg('Connected to: ' + (flDevice.name || flDevice.id), 'success');

    // Get Custom service
    try {
      var customSvc = await flServer.getPrimaryService(UUID_CUSTOM_SVC);
      flCustomChar = await customSvc.getCharacteristic(UUID_CUSTOM_CHAR);
      await flCustomChar.startNotifications();
      flCustomChar.addEventListener('characteristicvaluechanged', onFlasherNotification);
      flLogMsg('Custom service ready (0x1F10)', 'success');
    } catch (e) {
      flLogMsg('Custom service not found: ' + e.message, 'warn');
    }

    // Get OTA service
    try {
      var otaSvc = await flServer.getPrimaryService(UUID_OTA_SVC);
      flOtaChar = await otaSvc.getCharacteristic(UUID_OTA_CHAR);
      flLogMsg('OTA service ready', 'success');
    } catch (e) {
      flLogMsg('OTA service not available: ' + e.message, 'warn');
    }

    flUpdateConnUI(true);

    // Show relevant sections
    document.getElementById('flDeviceInfo').classList.remove('hidden');
    if (flCustomChar) {
      ['flConfigSection','flComfortSection','flTriggerSection','flDevMgmtSection'].forEach(function(id) {
        document.getElementById(id).classList.remove('hidden');
      });
    }
    if (flOtaChar) {
      document.getElementById('flOtaSection').classList.remove('hidden');
    }
    // Show Mi auth for all devices
    document.getElementById('flMiAuthSection').classList.remove('hidden');

    // Read device info
    if (flCustomChar) {
      flLogMsg('Querying device info (cmd 0x55)...');
      await flCustomChar.writeValue(new Uint8Array([0x55]));
      // Also read full config
      await delay(200);
      flLogMsg('Reading configuration (cmd 0x55 10)...');
      await flCustomChar.writeValue(new Uint8Array([0x55, 0x10]));
    }

  } catch (err) {
    if (err.name !== 'NotFoundError') {
      flLogMsg('Connect failed: ' + err.message, 'error');
    } else {
      flLogMsg('No device selected', 'warn');
    }
  }
}

function flasherDisconnect() {
  if (flServer) {
    try { flServer.disconnect(); } catch (e) {}
  }
  flServer = null; flCustomChar = null; flOtaChar = null; flConfig = null; flDevice = null;
  flUpdateConnUI(false);
  flLogMsg('Disconnected', 'info');
}

function onFlasherNotification(event) {
  var value = event.target.value;
  var cmd = value.getUint8(0);
  var len = value.byteLength;

  if (cmd === 0x55) {
    // Device info / config response
    if (len >= 3 && value.getUint8(1) !== 0x10) {
      // Short info: hw_ver, sw_ver
      var hwVer = value.getUint8(1);
      var swVer = value.getUint8(2);
      var hwName = hwVer < FL_HW_VERSIONS.length ? FL_HW_VERSIONS[hwVer] : 'Unknown (' + hwVer + ')';
      var infoHtml =
        '<div class="flex justify-between"><span class="text-zinc-500">Hardware</span><span class="text-zinc-300">' + esc(hwName) + ' (ID: ' + hwVer + ')</span></div>' +
        '<div class="flex justify-between"><span class="text-zinc-500">Firmware</span><span class="text-zinc-300">v' + swVer + '</span></div>' +
        '<div class="flex justify-between"><span class="text-zinc-500">Device</span><span class="text-zinc-300">' + esc(flDevice ? flDevice.name || flDevice.id : '?') + '</span></div>';
      document.getElementById('flDevInfoContent').innerHTML = infoHtml;
      document.getElementById('flDevName').value = flDevice ? (flDevice.name || '') : '';
      flLogMsg('Device: ' + hwName + ', FW v' + swVer, 'info');
    }
    // Full config block (cmd 0x55 with sub-cmd 0x10, len >= 12)
    if (len >= 12) {
      parseFlasherConfig(value);
    }
  } else if (cmd === 0x44) {
    // Bind key response: 0x44 + 12 bytes (key may be 16 bytes if len >= 17, or partial)
    // Format: [0x44][key bytes...] — typically 12-16 bytes of key data
    var keyLen = len - 1;
    if (keyLen > 0) {
      var keyHex = '';
      for (var ki = 1; ki < len; ki++) {
        keyHex += ('0' + value.getUint8(ki).toString(16)).slice(-2);
      }
      document.getElementById('flMiBindKey').value = keyHex.toUpperCase();
      flLogMsg('Bind key received (' + keyLen + ' bytes): ' + keyHex.toUpperCase(), 'success');
    } else {
      flLogMsg('Bind key response empty — device may not have a key set', 'warn');
    }
  } else if (cmd === 0x45) {
    // Set bind key response
    if (len >= 2 && value.getUint8(1) === 0x00) {
      flLogMsg('Bind key written successfully', 'success');
    } else {
      flLogMsg('Bind key write response: status=' + (len >= 2 ? value.getUint8(1) : '?'), 'info');
    }
  } else if (cmd === 0x35) {
    // Trigger config response
    if (len >= 12) {
      parseTriggerConfig(value);
    }
  } else if (cmd === 0x15) {
    // Comfort config response
    if (len >= 9) {
      parseComfortConfig(value);
    }
  } else if (cmd === 0x56) {
    // Set name response
    flLogMsg('Device name set — device will advertise with new name after restart', 'success');
  } else if (cmd === 0x57) {
    // Set MAC response
    flLogMsg('MAC address set — device will restart', 'success');
  } else if (cmd === 0x70) {
    // Set pin code response
    flLogMsg('Pin code updated', 'success');
  } else {
    // Log unknown commands for debugging
    var hexDump = '';
    for (var hi = 0; hi < Math.min(len, 20); hi++) {
      hexDump += ('0' + value.getUint8(hi).toString(16)).slice(-2) + ' ';
    }
    flLogMsg('Notification cmd=0x' + cmd.toString(16) + ' len=' + len + ' data: ' + hexDump.trim(), 'info');
  }
}

function parseFlasherConfig(value) {
  var len = value.byteLength;
  try {
    flConfig = {};
    // Standard config block parsing (based on TelinkMiFlasher CustomBlkParse)
    if (len >= 10) {
      flConfig.advType = value.getUint8(1) & 0x0f;
      flConfig.flags = value.getUint8(1) >> 4;
      flConfig.tempOffset = value.getInt16(2, true);
      flConfig.humiOffset = value.getInt16(4, true);
      flConfig.advInterval = value.getUint16(6, true) * 0.625; // convert to ms
      flConfig.measInterval = value.getUint8(8);
      flConfig.txPower = value.getUint8(9);
    }
    if (len >= 14) {
      flConfig.connectLatency = value.getUint16(10, true);
      flConfig.lcdCfg = value.getUint8(12);
      flConfig.bt5phy = value.getUint8(13);
    }

    // Update UI fields
    document.getElementById('flAdvType').value = flConfig.advType || 0;
    document.getElementById('flAdvInterval').value = Math.round(flConfig.advInterval || 2500);
    document.getElementById('flMeasInterval').value = flConfig.measInterval || 4;
    document.getElementById('flTempOffset').value = flConfig.tempOffset || 0;
    document.getElementById('flHumiOffset').value = flConfig.humiOffset || 0;

    // Map TX power register to select index
    var txIdx = FL_TX_POWERS.findIndex(function(p) { return p.value === (flConfig.txPower || 7); });
    document.getElementById('flTxPower').value = txIdx >= 0 ? txIdx : 7;

    // Flags
    document.getElementById('flFlagScreen').checked = !!(flConfig.flags & 0x01);
    document.getElementById('flFlagBt5').checked = !!(flConfig.bt5phy);
    document.getElementById('flFlagLpMeasure').checked = !!(flConfig.flags & 0x04);
    document.getElementById('flFlagTempF').checked = !!(flConfig.lcdCfg & 0x01);

    flLogMsg('Config loaded: adv=' + ['ATC1441','Custom','Mi-Like','BTHome v1','BTHome v2'][flConfig.advType || 0] +
      ', interval=' + Math.round(flConfig.advInterval) + 'ms, measure=' + flConfig.measInterval + 's', 'success');

    // Request trigger and comfort configs
    if (flCustomChar) {
      flCustomChar.writeValue(new Uint8Array([0x35])).catch(function() {});
      delay(100).then(function() {
        flCustomChar.writeValue(new Uint8Array([0x15])).catch(function() {});
      });
    }
  } catch (e) {
    flLogMsg('Config parse error: ' + e.message, 'error');
  }
}

function parseTriggerConfig(value) {
  try {
    document.getElementById('flTrigTempThreshold').value = value.getInt16(2, true);
    document.getElementById('flTrigTempHyst').value = value.getInt16(4, true);
    document.getElementById('flTrigHumiThreshold').value = value.getInt16(6, true);
    document.getElementById('flTrigHumiHyst').value = value.getInt16(8, true);
    if (value.byteLength >= 11) {
      document.getElementById('flReedSwitch').value = value.getUint8(10);
    }
    flLogMsg('Trigger config loaded', 'info');
  } catch (e) {
    flLogMsg('Trigger parse error: ' + e.message, 'error');
  }
}

function parseComfortConfig(value) {
  try {
    document.getElementById('flComfortTempMin').value = value.getInt16(1, true);
    document.getElementById('flComfortTempMax').value = value.getInt16(3, true);
    document.getElementById('flComfortHumiMin').value = value.getInt16(5, true);
    document.getElementById('flComfortHumiMax').value = value.getInt16(7, true);
    flLogMsg('Comfort parameters loaded', 'info');
  } catch (e) {
    flLogMsg('Comfort parse error: ' + e.message, 'error');
  }
}

async function flasherReadConfig() {
  if (!flCustomChar) { flLogMsg('Not connected or no custom service', 'error'); return; }
  try {
    flLogMsg('Reading config...');
    await flCustomChar.writeValue(new Uint8Array([0x55]));
    await delay(200);
    await flCustomChar.writeValue(new Uint8Array([0x55, 0x10]));
  } catch (e) {
    flLogMsg('Read config failed: ' + e.message, 'error');
  }
}

async function flasherWriteConfig() {
  if (!flCustomChar) { flLogMsg('Not connected or no custom service', 'error'); return; }
  try {
    var advType = parseInt(document.getElementById('flAdvType').value) || 0;
    var flags = 0;
    if (document.getElementById('flFlagScreen').checked) flags |= 0x01;
    if (document.getElementById('flFlagLpMeasure').checked) flags |= 0x04;

    var cmd = new Uint8Array(14);
    cmd[0] = 0x55;
    cmd[1] = (advType & 0x0f) | (flags << 4);
    var dv = new DataView(cmd.buffer);
    dv.setInt16(2, parseInt(document.getElementById('flTempOffset').value) || 0, true);
    dv.setInt16(4, parseInt(document.getElementById('flHumiOffset').value) || 0, true);
    dv.setUint16(6, Math.round((parseInt(document.getElementById('flAdvInterval').value) || 2500) / 0.625), true);
    cmd[8] = parseInt(document.getElementById('flMeasInterval').value) || 4;
    cmd[9] = parseInt(document.getElementById('flTxPower').value) || 7;
    dv.setUint16(10, flConfig ? flConfig.connectLatency || 0 : 0, true);
    cmd[12] = document.getElementById('flFlagTempF').checked ? 1 : 0;
    cmd[13] = document.getElementById('flFlagBt5').checked ? 1 : 0;

    flLogMsg('Writing config...');
    await flCustomChar.writeValue(cmd);
    flLogMsg('Config written successfully!', 'success');

    // Write trigger config
    var trigCmd = new Uint8Array(12);
    trigCmd[0] = 0x35;
    trigCmd[1] = 0x10; // write sub-cmd
    var tdv = new DataView(trigCmd.buffer);
    tdv.setInt16(2, parseInt(document.getElementById('flTrigTempThreshold').value) || 0, true);
    tdv.setInt16(4, parseInt(document.getElementById('flTrigTempHyst').value) || 0, true);
    tdv.setInt16(6, parseInt(document.getElementById('flTrigHumiThreshold').value) || 0, true);
    tdv.setInt16(8, parseInt(document.getElementById('flTrigHumiHyst').value) || 0, true);
    trigCmd[10] = parseInt(document.getElementById('flReedSwitch').value) || 0;
    await flCustomChar.writeValue(trigCmd);
    flLogMsg('Trigger config written', 'success');

    // Write comfort config
    var comCmd = new Uint8Array(9);
    comCmd[0] = 0x15;
    var cdv = new DataView(comCmd.buffer);
    cdv.setInt16(1, parseInt(document.getElementById('flComfortTempMin').value) || 2000, true);
    cdv.setInt16(3, parseInt(document.getElementById('flComfortTempMax').value) || 2500, true);
    cdv.setInt16(5, parseInt(document.getElementById('flComfortHumiMin').value) || 4000, true);
    cdv.setInt16(7, parseInt(document.getElementById('flComfortHumiMax').value) || 6000, true);
    await flCustomChar.writeValue(comCmd);
    flLogMsg('Comfort config written', 'success');
    showAlert('Flasher: Config saved to device', 'success');
  } catch (e) {
    flLogMsg('Write config failed: ' + e.message, 'error');
    showAlert('Flasher: Config write failed — ' + e.message, 'error');
  }
}

async function flasherSetDevName() {
  if (!flCustomChar) { flLogMsg('Not connected', 'error'); return; }
  var name = document.getElementById('flDevName').value.trim();
  if (!name) { flLogMsg('Enter a device name', 'warn'); return; }
  try {
    var nameBytes = new TextEncoder().encode(name);
    var cmd = new Uint8Array(1 + nameBytes.length);
    cmd[0] = 0x56; // set name cmd
    cmd.set(nameBytes, 1);
    await flCustomChar.writeValue(cmd);
    flLogMsg('Device name set to: ' + name, 'success');
  } catch (e) {
    flLogMsg('Set name failed: ' + e.message, 'error');
  }
}

async function flasherSetMAC() {
  if (!flCustomChar) { flLogMsg('Not connected', 'error'); return; }
  var macStr = document.getElementById('flDevMAC').value.trim().replace(/[:\s-]/g, '');
  if (macStr.length !== 12) { flLogMsg('Invalid MAC address (need 12 hex chars)', 'warn'); return; }
  try {
    var macBytes = new Uint8Array(6);
    for (var i = 0; i < 6; i++) macBytes[i] = parseInt(macStr.substr(i * 2, 2), 16);
    var cmd = new Uint8Array(7);
    cmd[0] = 0x57; // set MAC cmd
    cmd.set(macBytes.reverse(), 1); // little-endian
    await flCustomChar.writeValue(cmd);
    flLogMsg('MAC set. Device will restart.', 'success');
  } catch (e) {
    flLogMsg('Set MAC failed: ' + e.message, 'error');
  }
}

async function flasherSetPinCode() {
  if (!flCustomChar) { flLogMsg('Not connected', 'error'); return; }
  var pin = parseInt(document.getElementById('flPinCode').value) || 0;
  try {
    var cmd = new Uint8Array(5);
    cmd[0] = 0x70; // set pincode cmd
    var dv = new DataView(cmd.buffer);
    dv.setUint32(1, pin, true);
    await flCustomChar.writeValue(cmd);
    flLogMsg('Pin code set to: ' + pin, 'success');
  } catch (e) {
    flLogMsg('Set pin failed: ' + e.message, 'error');
  }
}

/* ── Mi Authorization ── */
async function flasherMiGetBindKey() {
  if (!flCustomChar) { flLogMsg('Not connected', 'error'); return; }
  try {
    flLogMsg('Reading Mi Bind Key (cmd 0x44)...');
    await flCustomChar.writeValue(new Uint8Array([0x44]));
    // Response comes via notification, parsed in onFlasherNotification
    // We'll need to handle cmd 0x44 response
    flLogMsg('Bind key requested — check notification response', 'info');
  } catch (e) {
    flLogMsg('Get bind key failed: ' + e.message, 'error');
  }
}

async function flasherMiSetBindKey() {
  if (!flCustomChar) { flLogMsg('Not connected', 'error'); return; }
  var keyHex = document.getElementById('flMiBindKey').value.trim().replace(/[\s:-]/g, '');
  if (keyHex.length !== 32) { flLogMsg('Bind key must be 16 bytes (32 hex chars)', 'warn'); return; }
  try {
    var keyBytes = new Uint8Array(16);
    for (var i = 0; i < 16; i++) keyBytes[i] = parseInt(keyHex.substr(i * 2, 2), 16);
    var cmd = new Uint8Array(17);
    cmd[0] = 0x45; // set bind key cmd
    cmd.set(keyBytes, 1);
    await flCustomChar.writeValue(cmd);
    flLogMsg('Bind key set', 'success');
  } catch (e) {
    flLogMsg('Set bind key failed: ' + e.message, 'error');
  }
}

async function flasherMiActivate() {
  if (!flServer) { flLogMsg('Not connected', 'error'); return; }
  flLogMsg('Mi Activation starting...', 'info');
  flLogMsg('Note: Full Mi auth (ECDH key exchange) requires crypto.subtle.', 'info');

  try {
    // Try to get the Mi auth service (0xfe95)
    var miAuthSvc = null;
    try {
      miAuthSvc = await flServer.getPrimaryService(0xfe95);
      flLogMsg('Mi auth service (0xFE95) found', 'success');
    } catch (e) {
      flLogMsg('Mi auth service not available. Device may already be running custom firmware.', 'warn');
      return;
    }

    // Get auth characteristics
    var charAuth = await miAuthSvc.getCharacteristic(0x0010);
    var charVer = await miAuthSvc.getCharacteristic(0x0004);
    await charAuth.startNotifications();

    // ECDH key exchange
    flLogMsg('Generating ECDH P-256 key pair...');
    var keyPair = await crypto.subtle.generateKey({ name: 'ECDH', namedCurve: 'P-256' }, true, ['deriveBits']);
    var pubKeyRaw = await crypto.subtle.exportKey('raw', keyPair.publicKey);
    var myPubKey = new Uint8Array(pubKeyRaw);

    flLogMsg('Sending public key to device...');

    // Listen for auth responses
    var authResolve = null;
    var authPromise = new Promise(function(resolve) { authResolve = resolve; });
    var authData = [];

    charAuth.addEventListener('characteristicvaluechanged', function(ev) {
      var val = new Uint8Array(ev.target.value.buffer);
      authData.push(val);
      if (val[0] === 0x00 && val[1] === 0x00 && val[2] === 0x01 && val[3] === 0x01) {
        flLogMsg('Auth step 1: Device ready', 'info');
      } else if (val[0] === 0x00 && val[1] === 0x00 && val[2] === 0x01 && val[3] === 0x00) {
        flLogMsg('Auth step 1: Device confirmed', 'success');
      } else if (val[0] === 0x02) {
        flLogMsg('Auth response: token/key data received', 'info');
        authResolve(authData);
      }
    });

    // Step 1: Send auth init
    await charAuth.writeValue(new Uint8Array([0x00, 0x00, 0x01, 0x00]));
    await delay(500);

    // Step 2: Send our public key in chunks
    var chunkSize = 18;
    for (var i = 0; i < myPubKey.length; i += chunkSize) {
      var chunk = myPubKey.slice(i, Math.min(i + chunkSize, myPubKey.length));
      var pkt = new Uint8Array(2 + chunk.length);
      pkt[0] = 0x00; pkt[1] = 0x0c;
      pkt.set(chunk, 2);
      await charAuth.writeValue(pkt);
      await delay(50);
    }

    // Step 3: Request device's public key
    await charAuth.writeValue(new Uint8Array([0x00, 0x00, 0x03, 0x00]));
    flLogMsg('Waiting for device auth response...', 'info');

    // Wait for response (timeout 10s)
    var timeout = setTimeout(function() { authResolve(null); }, 10000);
    var result = await authPromise;
    clearTimeout(timeout);

    if (!result) {
      flLogMsg('Mi auth timeout — device may need reset', 'error');
      return;
    }

    flLogMsg('Mi activation flow completed. Check bind key field.', 'success');
    showAlert('Mi activation attempted — check Flasher log', 'success');

  } catch (e) {
    flLogMsg('Mi activation failed: ' + e.message, 'error');
  }
}

/* ── Remote Firmware Loading ── */
async function flasherLoadRemoteFw() {
  flLogMsg('Loading firmware list from GitHub...', 'info');
  try {
    var resp = await fetch('https://pvvx.github.io/ATC_MiThermometer/firmware.json');
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    var data = await resp.json();
    flRemoteFirmwares = [];
    var select = document.getElementById('flFwSource');
    select.innerHTML = '<option value="">— select firmware —</option>';

    // Parse firmware.json entries
    if (Array.isArray(data)) {
      data.forEach(function(fw, idx) {
        var name = fw.name || fw.file || ('Firmware ' + idx);
        var url = fw.url || fw.file;
        if (url && !url.startsWith('http')) {
          url = 'https://pvvx.github.io/ATC_MiThermometer/' + url;
        }
        flRemoteFirmwares.push({ name: name, url: url, desc: fw.desc || '' });
        select.innerHTML += '<option value="' + idx + '">' + esc(name) + (fw.desc ? ' — ' + esc(fw.desc) : '') + '</option>';
      });
      flLogMsg('Loaded ' + flRemoteFirmwares.length + ' firmware entries', 'success');
    } else if (typeof data === 'object') {
      // Handle object format
      Object.keys(data).forEach(function(key, idx) {
        var fw = data[key];
        var name = key;
        var url = typeof fw === 'string' ? fw : (fw.url || fw.file || '');
        if (url && !url.startsWith('http')) {
          url = 'https://pvvx.github.io/ATC_MiThermometer/' + url;
        }
        flRemoteFirmwares.push({ name: name, url: url, desc: '' });
        select.innerHTML += '<option value="' + idx + '">' + esc(name) + '</option>';
      });
      flLogMsg('Loaded ' + flRemoteFirmwares.length + ' firmware entries', 'success');
    }
  } catch (e) {
    flLogMsg('Failed to load firmware list: ' + e.message, 'error');
    showAlert('Failed to fetch firmware list from GitHub', 'error');
  }
}

// Handle advanced firmware source selection
document.addEventListener('change', function(e) {
  if (e.target.id === 'flFwSource') {
    var idx = parseInt(e.target.value);
    if (isNaN(idx) || !flRemoteFirmwares[idx]) return;
    var fw = flRemoteFirmwares[idx];
    flLogMsg('Downloading: ' + fw.name + '...');
    fetch(fw.url)
      .then(function(resp) {
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return resp.arrayBuffer();
      })
      .then(function(buf) {
        flFirmwareData = buf;
        flFirmwareInfo = validateFirmware(buf);
        var infoEl = document.getElementById('flAdvFwInfo');
        infoEl.classList.remove('hidden');
        if (flFirmwareInfo.valid) {
          infoEl.innerHTML =
            '<div class="flex justify-between"><span class="text-zinc-500">File</span><span class="text-zinc-300">' + esc(fw.name) + '</span></div>' +
            '<div class="flex justify-between"><span class="text-zinc-500">Size</span><span class="text-zinc-300">' + (flFirmwareInfo.size / 1024).toFixed(1) + ' KB</span></div>' +
            '<div class="flex justify-between"><span class="text-zinc-500">CRC32</span><span class="text-zinc-300">0x' + flFirmwareInfo.calcCrc.toString(16).toUpperCase() + '</span></div>' +
            '<div class="flex justify-between"><span class="text-zinc-500">Status</span><span class="text-green-400">Valid Telink firmware</span></div>';
          document.getElementById('btnFlAdvFlash').disabled = false;
          flLogMsg('Firmware loaded: ' + fw.name + ' (' + (buf.byteLength / 1024).toFixed(1) + ' KB)', 'success');
        } else {
          infoEl.innerHTML =
            '<div class="flex justify-between"><span class="text-zinc-500">File</span><span class="text-zinc-300">' + esc(fw.name) + '</span></div>' +
            '<div class="text-red-400">' + esc(flFirmwareInfo.error) + '</div>';
          document.getElementById('btnFlAdvFlash').disabled = true;
          flLogMsg('Invalid firmware: ' + flFirmwareInfo.error, 'error');
        }
      })
      .catch(function(err) {
        flLogMsg('Download failed: ' + err.message, 'error');
      });
  }
});

async function flasherStartOTA() {
  if (!flOtaChar) { flLogMsg('No OTA service', 'error'); return; }
  if (!flFirmwareData || !flFirmwareInfo || !flFirmwareInfo.valid) { flLogMsg('No valid firmware loaded', 'error'); return; }
  if (otaInProgress) return;

  var devName = flDevice ? (flDevice.name || 'device') : 'device';
  if (!confirm('Flash firmware to "' + devName + '"?\n\nDo not disconnect during the process.')) return;

  otaInProgress = true;
  document.getElementById('btnFlAdvFlash').disabled = true;
  var progressBar = document.getElementById('flAdvOtaProgress');
  var progressFill = document.getElementById('flAdvOtaProgressFill');
  var statusEl = document.getElementById('flAdvOtaStatus');
  progressBar.classList.remove('hidden');
  progressFill.style.width = '0%';

  var fw = new Uint8Array(flFirmwareData);
  var blockSize = 16;
  var totalBlocks = Math.ceil(fw.length / blockSize);

  try {
    flLogMsg('OTA start: ' + totalBlocks + ' blocks, ' + fw.length + ' bytes', 'info');
    statusEl.textContent = 'Starting OTA...';
    statusEl.className = 'text-center text-xs text-zinc-400 font-mono mb-3';

    await flOtaChar.writeValueWithoutResponse(new Uint8Array([0x00, 0xff]));
    await delay(50);
    await flOtaChar.writeValueWithoutResponse(new Uint8Array([0x01, 0xff]));
    await delay(50);

    var batchStart = performance.now();
    for (var blockNr = 0; blockNr < totalBlocks; blockNr++) {
      var dataStart = blockNr * blockSize;
      var dataEnd = Math.min(dataStart + blockSize, fw.length);
      var blockData = fw.slice(dataStart, dataEnd);
      var padded = new Uint8Array(blockSize);
      padded.set(blockData);
      var payload = new Uint8Array(2 + blockSize);
      payload[0] = blockNr & 0xff;
      payload[1] = (blockNr >> 8) & 0xff;
      payload.set(padded, 2);
      var crc = crc16modbus(payload);
      var packet = new Uint8Array(payload.length + 2);
      packet.set(payload);
      packet[payload.length] = crc & 0xff;
      packet[payload.length + 1] = (crc >> 8) & 0xff;
      await flOtaChar.writeValueWithoutResponse(packet);

      if ((blockNr & 7) === 7 || blockNr === totalBlocks - 1) {
        try { await flOtaChar.readValue(); } catch (e) {}
        var pct = Math.round(((blockNr + 1) / totalBlocks) * 100);
        progressFill.style.width = pct + '%';
        statusEl.textContent = 'Flashing: ' + (blockNr + 1) + ' / ' + totalBlocks + ' (' + pct + '%)';
        if ((blockNr & 63) === 63) flLogMsg('Progress: ' + pct + '%');
      }
    }

    var endPacket = new Uint8Array(6);
    endPacket[0] = 0x02; endPacket[1] = 0xff;
    var lastBlock = totalBlocks - 1;
    endPacket[2] = lastBlock & 0xff; endPacket[3] = (lastBlock >> 8) & 0xff;
    var notLastBlock = (~lastBlock) & 0xffff;
    endPacket[4] = notLastBlock & 0xff; endPacket[5] = (notLastBlock >> 8) & 0xff;
    await flOtaChar.writeValueWithoutResponse(endPacket);

    progressFill.style.width = '100%';
    statusEl.textContent = 'Firmware update complete! Device will restart.';
    statusEl.className = 'text-center text-xs text-green-400 font-mono mb-3';
    flLogMsg('OTA COMPLETE: ' + fw.length + ' bytes, ' + totalBlocks + ' blocks', 'success');
    showAlert('Firmware flashed successfully!', 'success');
  } catch (err) {
    statusEl.textContent = 'OTA failed: ' + err.message;
    statusEl.className = 'text-center text-xs text-red-400 font-mono mb-3';
    flLogMsg('OTA FAILED: ' + err.message, 'error');
    showAlert('Firmware flash failed: ' + err.message, 'error');
  } finally {
    otaInProgress = false;
    document.getElementById('btnFlAdvFlash').disabled = false;
  }
}

/* ── OTA Firmware Flashing ── */
function crc16modbus(buffer) {
  var crc = 0xFFFF;
  for (var i = 0; i < buffer.length; i++) {
    crc ^= buffer[i];
    for (var j = 0; j < 8; j++) {
      var odd = crc & 1;
      crc >>= 1;
      if (odd) crc ^= 0xA001;
    }
  }
  return crc;
}

var crc32 = (function() {
  var table = new Uint32Array(256);
  for (var i = 256; i--;) {
    var tmp = i;
    for (var k = 8; k--;) tmp = tmp & 1 ? 0xEDB88320 ^ tmp >>> 1 : tmp >>> 1;
    table[i] = tmp;
  }
  return function(data) {
    var crc = -1;
    for (var i = 0; i < data.length; i++) crc = crc >>> 8 ^ table[crc & 255 ^ data[i]];
    return (crc >>> 0);
  };
})();

function validateFirmware(data) {
  if (!data || data.byteLength < 0x20) return { valid: false, error: 'File too small' };
  if (data.byteLength > MAX_EXT_OTA_SIZE) return { valid: false, error: 'File too large (' + (data.byteLength / 1024).toFixed(0) + ' KB, max ' + (MAX_EXT_OTA_SIZE / 1024) + ' KB)' };
  var head = new DataView(data);
  var magic = head.getUint32(0x08, true);
  if (magic !== 0x544c4e4b) return { valid: false, error: 'Not a Telink firmware (missing TLNK header)' };
  var hsize = head.getUint32(0x18, true);
  if ((hsize & 0x0f) !== 4) return { valid: false, error: 'Invalid size pointer in header' };
  if (hsize > data.byteLength) return { valid: false, error: 'Size in header exceeds file size' };
  var calcCrc = crc32(new Uint8Array(data.slice(0, hsize - 4)));
  var fileCrc = new DataView(data, hsize - 4, 4).getUint32(0, true);
  if (calcCrc !== fileCrc) return { valid: false, error: 'CRC mismatch (calc: 0x' + calcCrc.toString(16) + ', file: 0x' + fileCrc.toString(16) + ')' };
  return { valid: true, size: data.byteLength, hsize: hsize, calcCrc: calcCrc, fileCrc: fileCrc };
}

function handleFirmwareFile(file) {
  var reader = new FileReader();
  reader.onload = function() {
    firmwareData = reader.result;
    firmwareInfo = validateFirmware(firmwareData);
    var info = document.getElementById('fwInfo');
    info.classList.remove('hidden');

    if (firmwareInfo.valid) {
      info.innerHTML =
        '<div class="flex justify-between"><span class="text-zinc-500">File</span><span class="text-zinc-300">' + esc(file.name) + '</span></div>' +
        '<div class="flex justify-between"><span class="text-zinc-500">Size</span><span class="text-zinc-300">' + (firmwareInfo.size / 1024).toFixed(1) + ' KB</span></div>' +
        '<div class="flex justify-between"><span class="text-zinc-500">CRC32</span><span class="text-zinc-300">0x' + firmwareInfo.calcCrc.toString(16).toUpperCase() + '</span></div>' +
        '<div class="flex justify-between"><span class="text-zinc-500">Status</span><span class="text-green-400">Valid Telink firmware</span></div>';
      document.getElementById('btnFlash').disabled = false;
    } else {
      info.innerHTML =
        '<div class="flex justify-between"><span class="text-zinc-500">File</span><span class="text-zinc-300">' + esc(file.name) + '</span></div>' +
        '<div class="flex justify-between"><span class="text-zinc-500">Size</span><span class="text-zinc-300">' + (file.size / 1024).toFixed(1) + ' KB</span></div>' +
        '<div class="text-red-400 mt-1">' + esc(firmwareInfo.error) + '</div>';
      document.getElementById('btnFlash').disabled = true;
    }
  };
  reader.readAsArrayBuffer(file);
}

async function startOTA() {
  var selectEl = document.getElementById('otaDeviceSelect');
  var targetId = selectEl.value;
  if (!targetId || !sensors[targetId]) { alert('Select a connected device.'); return; }
  var s = sensors[targetId];
  if (!s.otaChar) { alert('No OTA service on this device.'); return; }
  if (!firmwareData || !firmwareInfo || !firmwareInfo.valid) { alert('Load a valid firmware file first.'); return; }
  if (otaInProgress) return;
  var name = settings.names[targetId] || s.name;
  if (!confirm('Flash firmware to "' + name + '"?\n\nDo not disconnect during the process.')) return;

  otaInProgress = true;
  var btn = document.getElementById('btnFlash');
  btn.disabled = true;
  var progressBar = document.getElementById('otaProgress');
  var progressFill = document.getElementById('otaProgressFill');
  var statusEl = document.getElementById('otaStatus');
  progressBar.classList.remove('hidden');
  progressFill.style.width = '0%';
  statusEl.className = 'text-center text-sm text-zinc-400 font-mono mb-4';

  var fw = new Uint8Array(firmwareData);
  var blockSize = 16;
  var totalBlocks = Math.ceil(fw.length / blockSize);

  try {
    statusEl.textContent = 'Starting OTA...';
    var otaChar = s.otaChar;
    var otaStart = performance.now();
    blePerf.add('OTA', 'OTA start: ' + (settings.names[targetId] || name), null, { blocks: totalBlocks, bytes: fw.length });

    await bleTimed('OTA', 'OTA cmd 0x00ff (start)', function() {
      return otaChar.writeValueWithoutResponse(new Uint8Array([0x00, 0xff]));
    });
    await delay(50);
    await bleTimed('OTA', 'OTA cmd 0x01ff (begin)', function() {
      return otaChar.writeValueWithoutResponse(new Uint8Array([0x01, 0xff]));
    });
    await delay(50);
    statusEl.textContent = 'Flashing: 0 / ' + totalBlocks;

    var batchStart = performance.now();
    for (var blockNr = 0; blockNr < totalBlocks; blockNr++) {
      var dataStart = blockNr * blockSize;
      var dataEnd = Math.min(dataStart + blockSize, fw.length);
      var blockData = fw.slice(dataStart, dataEnd);
      var padded = new Uint8Array(blockSize);
      padded.set(blockData);
      var payload = new Uint8Array(2 + blockSize);
      payload[0] = blockNr & 0xff;
      payload[1] = (blockNr >> 8) & 0xff;
      payload.set(padded, 2);
      var crc = crc16modbus(payload);
      var packet = new Uint8Array(payload.length + 2);
      packet.set(payload);
      packet[payload.length] = crc & 0xff;
      packet[payload.length + 1] = (crc >> 8) & 0xff;
      await otaChar.writeValueWithoutResponse(packet);

      if ((blockNr & 7) === 7 || blockNr === totalBlocks - 1) {
        var batchDur = performance.now() - batchStart;
        var batchBlocks = Math.min(8, blockNr + 1);
        var throughput = Math.round((batchBlocks * blockSize) / (batchDur / 1000));
        try { await otaChar.readValue(); } catch (e) {}
        var pct = Math.round(((blockNr + 1) / totalBlocks) * 100);
        progressFill.style.width = pct + '%';
        statusEl.textContent = 'Flashing: ' + (blockNr + 1) + ' / ' + totalBlocks + ' (' + pct + '%)';
        blePerf.add('OTA', 'Batch ' + (blockNr + 1) + '/' + totalBlocks + ' (' + pct + '%)', batchDur, {
          throughput: throughput + ' B/s'
        });
        batchStart = performance.now();
      }
    }

    statusEl.textContent = 'Finalizing...';
    var endPacket = new Uint8Array(6);
    endPacket[0] = 0x02; endPacket[1] = 0xff;
    var lastBlock = totalBlocks - 1;
    endPacket[2] = lastBlock & 0xff;
    endPacket[3] = (lastBlock >> 8) & 0xff;
    var notLastBlock = (~lastBlock) & 0xffff;
    endPacket[4] = notLastBlock & 0xff;
    endPacket[5] = (notLastBlock >> 8) & 0xff;
    await otaChar.writeValueWithoutResponse(endPacket);

    progressFill.style.width = '100%';
    statusEl.textContent = 'Firmware update complete! Device will restart.';
    statusEl.className = 'text-center text-sm text-green-400 font-mono mb-4';
    blePerf.add('OTA', 'OTA COMPLETE', performance.now() - otaStart, { bytes: fw.length, blocks: totalBlocks });
  } catch (err) {
    statusEl.textContent = 'OTA failed: ' + err.message;
    statusEl.className = 'text-center text-sm text-red-400 font-mono mb-4';
    blePerf.add('OTA', 'OTA FAILED: ' + err.message, performance.now() - otaStart);
  } finally {
    otaInProgress = false;
    btn.disabled = false;
  }
}

function delay(ms) { return new Promise(function(r) { setTimeout(r, ms); }); }

/* ── Tabs ── */
document.querySelectorAll('.tab-btn').forEach(function(tab) {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.tab-btn').forEach(function(t) {
      t.className = 'tab-btn flex-1 text-center py-2.5 rounded-lg font-mono text-xs font-bold transition-colors text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800';
    });
    tab.className = 'tab-btn flex-1 text-center py-2.5 rounded-lg font-mono text-xs font-bold transition-colors bg-amber-500 text-zinc-900';
    document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.add('hidden'); });
    document.getElementById('tab-' + tab.dataset.tab).classList.remove('hidden');
    if (tab.dataset.tab === 'charts') renderCharts();
    if (tab.dataset.tab === 'flasher') lucide.createIcons();
    lucide.createIcons();
  });
});

/* ── File Drop (Simple mode) ── */
var fileDrop = document.getElementById('fileDrop');
var fwFileInput = document.getElementById('fwFile');
fileDrop.addEventListener('click', function() { fwFileInput.click(); });
fileDrop.addEventListener('dragover', function(e) { e.preventDefault(); fileDrop.classList.add('border-amber-500/50'); });
fileDrop.addEventListener('dragleave', function() { fileDrop.classList.remove('border-amber-500/50'); });
fileDrop.addEventListener('drop', function(e) {
  e.preventDefault();
  fileDrop.classList.remove('border-amber-500/50');
  if (e.dataTransfer.files.length) handleFirmwareFile(e.dataTransfer.files[0]);
});
fwFileInput.addEventListener('change', function() {
  if (fwFileInput.files.length) handleFirmwareFile(fwFileInput.files[0]);
});

/* ── File Drop (Advanced mode) ── */
var flAdvFileDrop = document.getElementById('flAdvFileDrop');
var flAdvFwFile = document.getElementById('flAdvFwFile');
if (flAdvFileDrop && flAdvFwFile) {
  flAdvFileDrop.addEventListener('click', function() { flAdvFwFile.click(); });
  flAdvFileDrop.addEventListener('dragover', function(e) { e.preventDefault(); flAdvFileDrop.classList.add('border-amber-500/50'); });
  flAdvFileDrop.addEventListener('dragleave', function() { flAdvFileDrop.classList.remove('border-amber-500/50'); });
  flAdvFileDrop.addEventListener('drop', function(e) {
    e.preventDefault();
    flAdvFileDrop.classList.remove('border-amber-500/50');
    if (e.dataTransfer.files.length) handleAdvFirmwareFile(e.dataTransfer.files[0]);
  });
  flAdvFwFile.addEventListener('change', function() {
    if (flAdvFwFile.files.length) handleAdvFirmwareFile(flAdvFwFile.files[0]);
  });
}

function handleAdvFirmwareFile(file) {
  var reader = new FileReader();
  reader.onload = function() {
    flFirmwareData = reader.result;
    flFirmwareInfo = validateFirmware(flFirmwareData);
    var info = document.getElementById('flAdvFwInfo');
    info.classList.remove('hidden');
    if (flFirmwareInfo.valid) {
      info.innerHTML =
        '<div class="flex justify-between"><span class="text-zinc-500">File</span><span class="text-zinc-300">' + esc(file.name) + '</span></div>' +
        '<div class="flex justify-between"><span class="text-zinc-500">Size</span><span class="text-zinc-300">' + (flFirmwareInfo.size / 1024).toFixed(1) + ' KB</span></div>' +
        '<div class="flex justify-between"><span class="text-zinc-500">CRC32</span><span class="text-zinc-300">0x' + flFirmwareInfo.calcCrc.toString(16).toUpperCase() + '</span></div>' +
        '<div class="flex justify-between"><span class="text-zinc-500">Status</span><span class="text-green-400">Valid Telink firmware</span></div>';
      document.getElementById('btnFlAdvFlash').disabled = false;
      flLogMsg('Local firmware loaded: ' + file.name + ' (' + (file.size / 1024).toFixed(1) + ' KB)', 'success');
    } else {
      info.innerHTML =
        '<div class="flex justify-between"><span class="text-zinc-500">File</span><span class="text-zinc-300">' + esc(file.name) + '</span></div>' +
        '<div class="text-red-400">' + esc(flFirmwareInfo.error) + '</div>';
      document.getElementById('btnFlAdvFlash').disabled = true;
      flLogMsg('Invalid firmware: ' + flFirmwareInfo.error, 'error');
    }
  };
  reader.readAsArrayBuffer(file);
}

/* ── Helpers ── */
function esc(str) {
  var d = document.createElement('div');
  d.textContent = str || '';
  return d.innerHTML;
}

function timeAgo(date) {
  var s = Math.floor((Date.now() - date.getTime()) / 1000);
  if (s < 5) return 'just now';
  if (s < 60) return s + 's ago';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  return Math.floor(s / 3600) + 'h ago';
}

/* ── Auto-refresh ── */
setInterval(renderDashboard, 5000);
// Per-sensor polling: check every second, only poll sensors whose interval has elapsed
// Skipped entirely in advert mode — data arrives passively via BLE advertisements
/* ── Active polling removed ──
   ATC firmware pushes 0x33 notifications at its own measure interval.
   We no longer write 0x33 actively — the receive-side throttle in
   onCustomNotification / onMiNotification gates storage & alerts to
   the user's configured poll rate while still updating live UI values.
   To change the firmware's push interval, use Flasher → Advanced →
   Sensor Configuration → "Measure Interval (s)" (cmd 0x55).          */
setInterval(cleanOldData, 3600000);

function requestNotificationPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

/* ── PWA Install Prompt ── */
var deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', function(e) {
  e.preventDefault();
  deferredInstallPrompt = e;
  showInstallBanner();
});

function showInstallBanner() {
  if (document.getElementById('installBanner')) return;
  var banner = document.createElement('div');
  banner.id = 'installBanner';
  banner.className = 'fixed bottom-4 left-4 right-4 md:left-auto md:right-6 md:w-96 bg-zinc-900 border border-amber-500/50 rounded-lg p-4 shadow-lg shadow-amber-500/10 z-50 flex items-center gap-3';
  banner.innerHTML =
    '<div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center shrink-0">' +
      '<i data-lucide="download" class="w-5 h-5 text-amber-500"></i>' +
    '</div>' +
    '<div class="flex-1 min-w-0">' +
      '<div class="font-mono font-bold text-zinc-100 text-sm">Install FSCMS</div>' +
      '<div class="text-xs text-zinc-500">Add to home screen for the best experience</div>' +
    '</div>' +
    '<button onclick="installPWA()" class="bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold text-xs px-3 py-1.5 rounded-lg transition-colors shrink-0">Install</button>' +
    '<button onclick="dismissInstall()" class="text-zinc-600 hover:text-zinc-400 transition-colors shrink-0 ml-1"><i data-lucide="x" class="w-4 h-4"></i></button>';
  document.body.appendChild(banner);
  lucide.createIcons();
}

async function installPWA() {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  var result = await deferredInstallPrompt.userChoice;
  deferredInstallPrompt = null;
  dismissInstall();
}

function dismissInstall() {
  var banner = document.getElementById('installBanner');
  if (banner) banner.remove();
}

/* ── Init ── */
async function init() {
  loadKnownDevices();
  loadSettings();
  await openDB();
  cleanOldData();
  requestNotificationPermission();
  renderDashboard();
  lucide.createIcons();
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(function(e) {});
  }
  // Render saved devices — manual reconnect via per-card buttons
  renderDashboard();

  // Display build hash in UI
  var hash = BUILD_HASH;
  var isSet = hash && hash !== '__BUILD_HASH__';
  var versionStr = isSet ? 'build ' + hash : 'v2.0-dev';
  var headerVer = document.querySelector('h1 span');
  if (headerVer) headerVer.textContent = versionStr;
  var aboutVer = document.getElementById('aboutVersion');
  if (aboutVer) aboutVer.textContent = versionStr + ' — Web Bluetooth Edition';
  var aboutHash = document.getElementById('aboutBuildHash');
  if (aboutHash) aboutHash.textContent = versionStr;
  // Log build hash for debugging
  console.log('%c[FSCMS] Build: ' + (isSet ? hash : 'dev (no commit hash)'), 'color:#f59e0b;font-weight:bold');
  blePerf.add('INIT', 'FSCMS build: ' + (isSet ? hash : 'dev'), null);

  // Resume advert scan if that was the saved mode
  if (settings.bleMode === 'advert') {
    startAdvertScan();
  }
}

function openDebugPanel() {
  var modal = document.getElementById('debugModal');
  modal.classList.remove('hidden');
  blePerf.renderPanel();
  updateDebugConnSummary();
  document.getElementById('debugLogCount').textContent = blePerf.log.length + ' entries';
  var hashEl = document.getElementById('debugBuildHash');
  if (hashEl) {
    var h = BUILD_HASH;
    hashEl.textContent = (h && h !== '__BUILD_HASH__') ? 'build: ' + h : 'dev build';
  }
  lucide.createIcons();
}
function closeDebugPanel() {
  document.getElementById('debugModal').classList.add('hidden');
}
function updateDebugConnSummary() {
  var el = document.getElementById('debugConnSummary');
  if (!el) return;
  var ids = Object.keys(sensors);
  if (ids.length === 0) { el.innerHTML = '<div class="text-zinc-600">No connections.</div>'; return; }
  el.innerHTML = ids.map(function(id) {
    var s = sensors[id];
    var name = settings.names[id] || s.name || id.substr(0, 12);
    var connected = s.server ? '<span class="text-green-400">connected</span>' : '<span class="text-red-400">disconnected</span>';
    var svc = s.customChar ? 'ATC' : s.miTempChar ? 'Mi' : 'none';
    var ota = s.otaChar ? 'yes' : 'no';
    return '<div class="flex justify-between"><span class="text-zinc-400">' + esc(name) + '</span>' +
      '<span>' + connected + ' | svc: ' + svc + ' | ota: ' + ota + '</span></div>';
  }).join('');
}
function exportDebugLog() {
  var lines = blePerf.log.map(function(e) {
    var dur = e.ms !== null ? ' [' + e.ms.toFixed(1) + 'ms]' : '';
    var ex = e.extra ? ' ' + JSON.stringify(e.extra) : '';
    return e.t + ' [' + e.cat + '] ' + e.label + dur + ex;
  });
  // Add sensor stats
  lines.push('', '=== NOTIFICATION RATES ===');
  Object.keys(blePerf.sensorStats).forEach(function(sid) {
    var r = blePerf.getSensorRate(sid);
    if (!r) return;
    var name = settings.names[sid] || (sensors[sid] ? sensors[sid].name : sid);
    lines.push(name + ': ' + r.count + ' msgs, avg=' + r.avgMs + 'ms, min=' + r.minMs + 'ms, max=' + r.maxMs + 'ms');
  });
  var blob = new Blob([lines.join('\n')], { type: 'text/plain' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url; a.download = 'fscms-ble-debug-' + new Date().toISOString().substr(0, 19).replace(/:/g, '') + '.txt';
  a.click(); URL.revokeObjectURL(url);
}

function openAddSensorModal() {
  document.getElementById('addSensorModal').classList.remove('hidden');
  lucide.createIcons();
}
function closeAddSensorModal() {
  document.getElementById('addSensorModal').classList.add('hidden');
}
function modalAutoPair() {
  closeAddSensorModal();
  autoPairATC();
}
function modalManualAdd() {
  closeAddSensorModal();
  scanAndConnect();
}
function reconnectAllSaved() {
  closeAddSensorModal();
  batchReconnect();
}

init();
</script>

<!-- Add Sensor Modal -->
<div id="addSensorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeAddSensorModal()"></div>
  <div class="relative bg-zinc-900 border border-zinc-700 rounded-xl p-6 w-full max-w-sm shadow-2xl">
    <div class="flex justify-between items-center mb-5">
      <h2 class="font-mono font-bold text-zinc-100 text-lg">Add Sensor</h2>
      <button onclick="closeAddSensorModal()" class="text-zinc-500 hover:text-zinc-300 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>
    <div class="space-y-3">
      <button onclick="modalAutoPair()" class="w-full bg-amber-500 hover:bg-amber-400 text-zinc-900 font-mono font-bold px-4 py-3 rounded-lg transition-colors flex items-center gap-3">
        <i data-lucide="bluetooth" class="w-5 h-5"></i>
        <div class="text-left">
          <div class="text-sm">Auto Pair ATC Sensors</div>
          <div class="text-xs font-normal opacity-70">Scan for all nearby ATC_ devices</div>
        </div>
      </button>
      <button onclick="modalManualAdd()" class="w-full bg-zinc-700 hover:bg-zinc-600 text-zinc-300 font-mono px-4 py-3 rounded-lg transition-colors flex items-center gap-3">
        <i data-lucide="plus-circle" class="w-5 h-5"></i>
        <div class="text-left">
          <div class="text-sm font-bold">Pick Single ATC Sensor</div>
          <div class="text-xs font-normal text-zinc-500">Select one ATC_ device from the picker</div>
        </div>
      </button>
      <button onclick="reconnectAllSaved()" class="w-full bg-zinc-700 hover:bg-zinc-600 text-zinc-300 font-mono px-4 py-3 rounded-lg transition-colors flex items-center gap-3">
        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
        <div class="text-left">
          <div class="text-sm font-bold">Reconnect All Saved</div>
          <div class="text-xs font-normal text-zinc-500">Auto-connect sequentially, no picker needed</div>
        </div>
      </button>
    </div>
    <p class="text-xs text-zinc-600 font-mono mt-4 text-center">The browser's Bluetooth picker will appear after selecting an option.</p>
  </div>
</div>

<!-- Forget Device Confirmation Modal -->
<div id="forgetModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" data-device-id="">
  <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeForgetModal()"></div>
  <div class="relative bg-zinc-900 border border-red-500/30 rounded-xl p-6 w-full max-w-sm shadow-2xl">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center shrink-0">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-red-400"></i>
      </div>
      <div>
        <h2 class="font-mono font-bold text-zinc-100 text-lg">Forget Sensor</h2>
        <div class="text-xs text-zinc-500 font-mono mt-0.5">This action cannot be undone</div>
      </div>
    </div>
    <div class="bg-zinc-800/50 rounded-lg p-4 mb-4 border border-zinc-700">
      <div class="font-mono font-bold text-zinc-200 text-sm" id="forgetDeviceName"></div>
      <div class="text-xs text-zinc-500 font-mono mt-0.5" id="forgetDeviceId"></div>
    </div>
    <p class="text-sm text-zinc-400 mb-5">This will permanently remove the sensor and <span class="text-red-400 font-bold">delete all logged temperature and humidity history</span> associated with it.</p>
    <div class="flex gap-3">
      <button onclick="closeForgetModal()" class="flex-1 bg-zinc-700 hover:bg-zinc-600 text-zinc-300 font-mono font-bold px-4 py-2.5 rounded-lg transition-colors text-sm">Cancel</button>
      <button onclick="confirmForgetDevice()" class="flex-1 bg-red-500/20 hover:bg-red-500/40 text-red-400 font-mono font-bold px-4 py-2.5 rounded-lg transition-colors text-sm border border-red-500/30 hover:border-red-500/50">Forget</button>
    </div>
  </div>
</div>

<!-- Alert History Modal -->
<div id="alertHistoryModal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
  <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeAlertHistory()"></div>
  <div class="relative bg-zinc-900 border border-zinc-700 sm:rounded-xl rounded-t-xl w-full sm:max-w-lg shadow-2xl flex flex-col" style="max-height:85vh">
    <div class="flex justify-between items-center p-4 border-b border-zinc-800 shrink-0">
      <div class="flex items-center gap-3">
        <i data-lucide="bell" class="w-5 h-5 text-amber-500"></i>
        <h2 class="font-mono font-bold text-zinc-100 text-lg">Alert History</h2>
        <span id="alertHistoryCount" class="text-xs text-zinc-500 font-mono"></span>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="clearAlertHistory()" class="text-xs text-zinc-500 hover:text-zinc-300 font-mono px-2 py-1 rounded bg-zinc-800 hover:bg-zinc-700 transition-colors">Clear</button>
        <button onclick="closeAlertHistory()" class="text-zinc-500 hover:text-zinc-300 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
    </div>
    <div id="alertHistoryList" class="px-3 py-3 overflow-y-auto flex-1 min-h-0 space-y-1.5">
      <div class="text-zinc-600 font-mono text-xs py-8 text-center">No alerts yet.</div>
    </div>
  </div>
</div>

<!-- Debug Log Modal -->
<div id="debugModal" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
  <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeDebugPanel()"></div>
  <div class="relative bg-zinc-900 border border-zinc-700 sm:rounded-xl rounded-t-xl w-full sm:max-w-3xl shadow-2xl flex flex-col" style="max-height:85vh">
    <div class="flex justify-between items-center p-4 border-b border-zinc-800 shrink-0">
      <div class="flex items-center gap-3">
        <i data-lucide="terminal" class="w-5 h-5 text-amber-500"></i>
        <h2 class="font-mono font-bold text-zinc-100 text-lg">BLE Debug Log</h2>
        <span id="debugLogCount" class="text-xs text-zinc-500 font-mono">0 entries</span>
        <span id="debugBuildHash" class="text-xs text-zinc-600 font-mono"></span>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="blePerf.clear()" class="text-xs text-zinc-500 hover:text-zinc-300 font-mono px-2 py-1 rounded bg-zinc-800 hover:bg-zinc-700 transition-colors">Clear</button>
        <button onclick="exportDebugLog()" class="text-xs text-zinc-500 hover:text-zinc-300 font-mono px-2 py-1 rounded bg-zinc-800 hover:bg-zinc-700 transition-colors">Export</button>
        <button onclick="closeDebugPanel()" class="text-zinc-500 hover:text-zinc-300 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
    </div>
    <!-- Notification rates -->
    <div class="px-4 py-3 border-b border-zinc-800 shrink-0">
      <div class="text-xs font-mono text-amber-500 mb-1.5">NOTIFICATION RATES</div>
      <div id="blePerfRates" class="text-xs font-mono space-y-0.5">
        <div class="text-zinc-600">No notifications yet.</div>
      </div>
    </div>
    <!-- Connection summary -->
    <div class="px-4 py-3 border-b border-zinc-800 shrink-0">
      <div class="text-xs font-mono text-amber-500 mb-1.5">ACTIVE CONNECTIONS</div>
      <div id="debugConnSummary" class="text-xs font-mono space-y-0.5">
        <div class="text-zinc-600">No connections.</div>
      </div>
    </div>
    <!-- Log entries -->
    <div class="px-4 py-3 overflow-y-auto flex-1 min-h-0">
      <div class="text-xs font-mono text-amber-500 mb-1.5">EVENT LOG <span class="text-zinc-600">(newest first, color = latency)</span></div>
      <div id="blePerfLog" class="text-xs font-mono space-y-0.5 leading-relaxed">
        <div class="text-zinc-600">No BLE activity yet.</div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
